<!DOCTYPE html>
<html lang="zh-CN" data-theme="cupcake">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.46">
    <link rel="manifest" href="/site.webmanifest.json"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><title>Vue 组件渲染机制 | </title><meta name="description" content="Just For Fun">
    <link rel="preload" href="/assets/js/runtime~app.7d4bd660.js" as="script"><link rel="preload" href="/assets/css/styles.1c65b737.css" as="style"><link rel="preload" href="/assets/js/5838.13a569e5.js" as="script"><link rel="preload" href="/assets/js/app.7e792774.js" as="script"><link rel="prefetch" href="/assets/js/v-03fc2322.47d94022.js"><link rel="prefetch" href="/assets/js/v-ba2c1988.3632b5e0.js"><link rel="prefetch" href="/assets/js/v-fd8e5af2.a9cafb88.js"><link rel="prefetch" href="/assets/js/v-5a071f34.190f1fdc.js"><link rel="prefetch" href="/assets/js/v-317472f1.a3c9dba2.js"><link rel="prefetch" href="/assets/js/v-560b844b.09f8a065.js"><link rel="prefetch" href="/assets/js/v-85bc3e4c.27575d9e.js"><link rel="prefetch" href="/assets/js/v-4835f72d.209f9a9b.js"><link rel="prefetch" href="/assets/js/v-6f2abf9c.c6a52b82.js"><link rel="prefetch" href="/assets/js/v-32c68258.46247de2.js"><link rel="prefetch" href="/assets/js/v-04983e79.ae40370a.js"><link rel="prefetch" href="/assets/js/v-7269d92e.00653b56.js"><link rel="prefetch" href="/assets/js/v-54e51afe.e3f20358.js"><link rel="prefetch" href="/assets/js/v-5fbdabee.afcc17b5.js"><link rel="prefetch" href="/assets/js/v-928f5a14.0a4a3dc4.js"><link rel="prefetch" href="/assets/js/v-88c7f226.529f6212.js"><link rel="prefetch" href="/assets/js/v-5e99732b.68dd2407.js"><link rel="prefetch" href="/assets/js/v-2fc78b4d.97b37f50.js"><link rel="prefetch" href="/assets/js/v-d99bba28.2cf82742.js"><link rel="prefetch" href="/assets/js/v-bee2f4a8.f072eb83.js"><link rel="prefetch" href="/assets/js/v-57ad8616.44af159f.js"><link rel="prefetch" href="/assets/js/v-f701b528.aa7f8f17.js"><link rel="prefetch" href="/assets/js/v-093d016d.bc725dd1.js"><link rel="prefetch" href="/assets/js/v-06ed95cc.0db5595a.js"><link rel="prefetch" href="/assets/js/v-01b20944.db789013.js"><link rel="prefetch" href="/assets/js/v-137d7552.50039c10.js"><link rel="prefetch" href="/assets/css/5045.styles.72ac531f.css"><link rel="prefetch" href="/assets/js/v-631fc68a.80740d81.js"><link rel="prefetch" href="/assets/js/v-8b5f7690.191ba9a3.js"><link rel="prefetch" href="/assets/js/v-530f22f6.f8e361fa.js"><link rel="prefetch" href="/assets/js/v-be2646cc.549f65bf.js"><link rel="prefetch" href="/assets/js/v-75e44f07.2f8601c3.js"><link rel="prefetch" href="/assets/js/v-c2504efe.28c55f92.js"><link rel="prefetch" href="/assets/js/v-5bc51cd9.b23c2caa.js"><link rel="prefetch" href="/assets/js/5956.f176ea33.js"><link rel="prefetch" href="/assets/js/v-6dc8e518.a8181c32.js"><link rel="prefetch" href="/assets/js/v-568d3b89.483d19f1.js"><link rel="prefetch" href="/assets/js/v-743faa02.3247db36.js"><link rel="prefetch" href="/assets/js/v-d52c6cc0.34d4b256.js"><link rel="prefetch" href="/assets/js/v-78263bfa.b7cb21e4.js"><link rel="prefetch" href="/assets/js/v-199de1f8.16ad6f91.js"><link rel="prefetch" href="/assets/js/v-30078430.3079f1d2.js"><link rel="prefetch" href="/assets/js/v-240dbb06.02e786fb.js"><link rel="prefetch" href="/assets/js/v-7a102f72.94a1b7e7.js"><link rel="prefetch" href="/assets/js/v-1402111c.9dc8cc11.js"><link rel="prefetch" href="/assets/js/v-f2bbc8da.fc4d9aa5.js"><link rel="prefetch" href="/assets/js/v-b0176dc2.b994ff0c.js"><link rel="prefetch" href="/assets/js/4644.1787b6ff.js"><link rel="prefetch" href="/assets/js/v-a5da5a08.cc633de8.js"><link rel="prefetch" href="/assets/js/v-acadbc84.800a32fa.js"><link rel="prefetch" href="/assets/js/v-a270a8ca.ea9c331c.js"><link rel="prefetch" href="/assets/js/v-a9440b46.63ee3544.js"><link rel="prefetch" href="/assets/js/6929.46233b49.js"><link rel="prefetch" href="/assets/js/9840.789f773b.js"><link rel="prefetch" href="/assets/js/v-9f06f78c.ff18832e.js"><link rel="prefetch" href="/assets/js/9870.c84a31ac.js"><link rel="prefetch" href="/assets/js/v-8daa1a0e.8245b191.js"><link rel="prefetch" href="/sw.js"><link rel="prefetch" href="/assets/css/3859.styles.7057c730.css">
    <link rel="stylesheet" href="/assets/css/styles.1c65b737.css">
</head>

<body>
    <div id="app"><!--[--><!--[--><div class="navbar sticky top-0 z-10"><a href="/" class=""><label class="btn btn-circle avatar"><div class="rounded-full ring ring-white shadow-2xl no-zoom"><img src="/avatar.webp"></div></label></a></div><div class="min-h-screen flex justify-center flex-col items-center"><article class="article w-full sm:w-3/4 lg:w-2/3 p-4" data-theme="cupcake"><div class="sm:max-w-full pb-12 prose sm:prose-sm md:prose-lg dark:prose-invert"><h1 id="vue-组件渲染机制" tabindex="-1"><a class="header-anchor" href="#vue-组件渲染机制" aria-hidden="true">#</a> Vue 组件渲染机制</h1><blockquote><p>以下示例代码基于 vue3.0、vue3.2（后续修改）</p></blockquote><p>任何前端框架，最主要的核心功能就是渲染视图。在 Vue 中，整个应用的页面都是通过<strong>组件</strong>来构成并渲染成页面。</p><p><img src="/assets/img/1281db002d7238b2948c8b50b3bb8882d7353ff9248c5f3049de3d0e3277a27d.aaf85a67.png" alt="picture 2"></p><p>在了解 vue 组件之前，先了解 VirtualDOM（在 vue 中则称为 vnode）。</p><h2 id="vnode" tabindex="-1"><a class="header-anchor" href="#vnode" aria-hidden="true">#</a> VNode</h2><p>Vue 的渲染原理中使用 <strong>VirtualDOM 机制</strong>，<strong>VirtualDOM 本质上是用来描述真实 DOM 的 JavaScript 对象</strong>。</p><p>我们可以用一个 vnode 对象去表示<code>&lt;button&gt;</code>节点。一个 VNode 的属性最主要的是节点类型 <code>type</code>，节点属性 <code>props</code>，字节点 <code>children</code>。</p><div class="language-html ext-html"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#24292F;">&lt;</span><span style="color:#116329;">button</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">class</span><span style="color:#24292F;">=</span><span style="color:#0A3069;">&quot;btn&quot;</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">style</span><span style="color:#24292F;">=</span><span style="color:#0A3069;">&quot;</span><span style="color:#24292F;">width:100px;height:50px&quot;</span><span style="color:#24292F;">&gt;click me&lt;/</span><span style="color:#116329;">button</span><span style="color:#24292F;">&gt;</span></span>
<span class="line"></span></code></pre></div><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">vnode</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">  type: </span><span style="color:#0A3069;">&quot;button&quot;</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  props: {</span></span>
<span class="line"><span style="color:#24292F;">    class: </span><span style="color:#0A3069;">&quot;btn&quot;</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    style: {</span></span>
<span class="line"><span style="color:#24292F;">      width: </span><span style="color:#0A3069;">&quot;100px&quot;</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">      height: </span><span style="color:#0A3069;">&quot;50px&quot;</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    },</span></span>
<span class="line"><span style="color:#24292F;">  },</span></span>
<span class="line"><span style="color:#24292F;">  children: </span><span style="color:#0A3069;">&quot;click me&quot;</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">};</span></span>
<span class="line"></span></code></pre></div><p>引入 VNode 的好处：</p><ol><li>任何常规的 GUI 都能用<strong>类 DOM 数据结构</strong>去描述，引入 VNode 主要是将视图<strong>抽象化</strong>，提供了<strong>跨平台</strong>能力</li><li><strong>UI is a value</strong> ：把视图当作一种变量值，能够进行<strong>编程化</strong></li><li>基于虚拟 DOM 实现状态驱动的 UI 开发方式：避免了手动操作 DOM 效率低下以及规避 XSS 风险</li></ol><p>vue 还提供很多的 VNode 类型：</p><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#6E7781;">// packages/runtime-core/src/vnode.ts</span></span>
<span class="line"><span style="color:#CF222E;">export</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">type</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNodeTypes</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">string</span><span style="color:#24292F;"> </span><span style="color:#6E7781;">// element</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;"> </span><span style="color:#6E7781;">// slot</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#953800;">Component</span><span style="color:#24292F;"> </span><span style="color:#6E7781;">// 组件</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">typeof</span><span style="color:#24292F;"> Text </span><span style="color:#6E7781;">// 文本</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">typeof</span><span style="color:#24292F;"> Static </span><span style="color:#6E7781;">// 静态</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">typeof</span><span style="color:#24292F;"> Comment </span><span style="color:#6E7781;">// 注释</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">typeof</span><span style="color:#24292F;"> Fragment </span><span style="color:#6E7781;">// 片段</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">typeof</span><span style="color:#24292F;"> TeleportImpl </span><span style="color:#6E7781;">// 传送组件</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">typeof</span><span style="color:#24292F;"> SuspenseImpl </span><span style="color:#6E7781;">// 挂载组件</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CF222E;">export</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">interface</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;">&lt;</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">HostNode</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#953800;">RendererNode</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">HostElement</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#953800;">RendererElement</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">ExtraProps</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> { [</span><span style="color:#953800;">key</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">string</span><span style="color:#24292F;">]</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">any</span><span style="color:#24292F;"> }</span></span>
<span class="line"><span style="color:#24292F;">&gt; {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">type</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNodeTypes</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">props</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> (</span><span style="color:#953800;">VNodeProps</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">&amp;</span><span style="color:#24292F;"> </span><span style="color:#953800;">ExtraProps</span><span style="color:#24292F;">) </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">children</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNodeNormalizedChildren</span></span>
<span class="line"><span style="color:#24292F;">	</span><span style="color:#CF222E;">...</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="vue-组件" tabindex="-1"><a class="header-anchor" href="#vue-组件" aria-hidden="true">#</a> Vue 组件</h2><p>组件是一种抽象概念、一种复用手段。</p><p>前端领域的组件化，即以视图为单位进行页面逻辑分割及复用，组件 = 视图模板 + 逻辑状态。</p><blockquote><p>但是以这样的组件为基本复用单位，在前端领域你会发现很难复用。有时视图模板符合了但逻辑状态稍微得修改，代码只会加入更多的 case by case；有时逻辑状态符合了但模板样式却不符合 UI 需求，这就导致前端组件往往限于一定的场景。</p><p>最佳形式是组件是视图构成基本单位、视图模板与逻辑状态是最小复用单位 🤔。</p></blockquote><p>基于 VirtualDOM 机制，<strong>组件本质上主要是对产生 vdom 的逻辑的封装</strong>。一个 Vue 组件的主要构成分层：</p><p><img src="/assets/img/1657120024564.5bdc5ae6.png" alt="图 2"></p><p>每一层的数据流依赖都是自顶向下：</p><ol><li>props/provide 外部对组件的输入</li><li>setup(data) 组件内部逻辑组织、视图状态输出</li><li>render 视图渲染，输出 vdom</li><li>slots 对外部提供自定义渲染接口</li></ol><h3 id="基于-virtualdom-的组件渲染机制" tabindex="-1"><a class="header-anchor" href="#基于-virtualdom-的组件渲染机制" aria-hidden="true">#</a> 基于 VirtualDOM 的组件渲染机制</h3><p>无论是 Vue 或者 React，基于 VirtualDOM 的数据驱动框架原理基本有以下几个重要步骤：</p><p><img src="/assets/img/1657525936169.64c59c19.png" alt="图 5"></p><ol><li>数据变动（或者初始数据）</li><li>Render：调度 Render 输出新 vdom</li><li>Diff：</li><li>Patch：执行系统平台对应的渲染命令</li></ol><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#CF222E;">import</span><span style="color:#24292F;"> { createVNode, patch, h } </span><span style="color:#CF222E;">from</span><span style="color:#24292F;"> </span><span style="color:#0A3069;">&quot;vue&quot;</span><span style="color:#24292F;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6E7781;">// 1. 组件定义</span></span>
<span class="line"><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">CustomComponent</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">  props: {</span></span>
<span class="line"><span style="color:#24292F;">    name: </span><span style="color:#0550AE;">String</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  },</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#8250DF;">setup</span><span style="color:#24292F;">(</span><span style="color:#953800;">props</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">      resolveName: </span><span style="color:#0A3069;">`hello ${</span><span style="color:#24292F;">props</span><span style="color:#0A3069;">.</span><span style="color:#24292F;">name</span><span style="color:#0A3069;">}`</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    };</span></span>
<span class="line"><span style="color:#24292F;">  },</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#8250DF;">render</span><span style="color:#24292F;">() {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">h</span><span style="color:#24292F;">(</span><span style="color:#0A3069;">&quot;div&quot;</span><span style="color:#24292F;">, [</span><span style="color:#0550AE;">this</span><span style="color:#24292F;">.resolveName, </span><span style="color:#0550AE;">this</span><span style="color:#24292F;">.$slots.</span><span style="color:#8250DF;">default</span><span style="color:#24292F;">()]);</span></span>
<span class="line"><span style="color:#24292F;">  },</span></span>
<span class="line"><span style="color:#24292F;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6E7781;">// 2. 创建组件的 vnode</span></span>
<span class="line"><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">vnode</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">createVNode</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">  CustomComponent,</span></span>
<span class="line"><span style="color:#24292F;">  { name: </span><span style="color:#0A3069;">&quot;world&quot;</span><span style="color:#24292F;"> },</span></span>
<span class="line"><span style="color:#24292F;">  {</span></span>
<span class="line"><span style="color:#24292F;">    default: </span><span style="color:#0A3069;">&quot;!&quot;</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"><span style="color:#24292F;">);</span></span>
<span class="line"><span style="color:#6E7781;">// vnode</span></span>
<span class="line"><span style="color:#6E7781;">//{</span></span>
<span class="line"><span style="color:#6E7781;">//  type: CustomComponent,</span></span>
<span class="line"><span style="color:#6E7781;">//  props: {</span></span>
<span class="line"><span style="color:#6E7781;">//    name: &#39;test&#39;</span></span>
<span class="line"><span style="color:#6E7781;">//  },</span></span>
<span class="line"><span style="color:#6E7781;">//  children: &#39;!&#39;</span></span>
<span class="line"><span style="color:#6E7781;">//}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6E7781;">// 3. 渲染 vnode（patch vnode）</span></span>
<span class="line"><span style="color:#8250DF;">render</span><span style="color:#24292F;">(vnode, document.</span><span style="color:#8250DF;">querySelector</span><span style="color:#24292F;">(</span><span style="color:#0A3069;">&quot;#app&quot;</span><span style="color:#24292F;">));</span></span>
<span class="line"><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">render</span><span style="color:#24292F;">(</span><span style="color:#953800;">vnode</span><span style="color:#24292F;">, </span><span style="color:#953800;">container</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// path 里会调用组件的 render，下面源码分析</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// old vnode 初始为 null，意味这是初始渲染，执行挂载操作</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#8250DF;">patch</span><span style="color:#24292F;">(vnode, </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">, container)</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6E7781;">// &lt;div&gt;hello world!&lt;/div&gt;</span></span>
<span class="line"></span></code></pre></div><h2 id="vue-组件渲染流程源码分析" tabindex="-1"><a class="header-anchor" href="#vue-组件渲染流程源码分析" aria-hidden="true">#</a> vue 组件渲染流程源码分析</h2><p>渲染流程分初始渲染和更新渲染，下面源码分析先从初始渲染流程。</p><h3 id="创建应用对象" tabindex="-1"><a class="header-anchor" href="#创建应用对象" aria-hidden="true">#</a> 创建应用对象</h3><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#6E7781;">// 在 Vue3 中，一个 vue 应用创建标准流程如下</span></span>
<span class="line"><span style="color:#CF222E;">import</span><span style="color:#24292F;"> { createApp } </span><span style="color:#CF222E;">from</span><span style="color:#24292F;"> </span><span style="color:#0A3069;">&#39;vue&#39;</span></span>
<span class="line"><span style="color:#CF222E;">import</span><span style="color:#24292F;"> App </span><span style="color:#CF222E;">from</span><span style="color:#24292F;"> </span><span style="color:#0A3069;">&#39;./app&#39;</span></span>
<span class="line"><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">app</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">createApp</span><span style="color:#24292F;">(App)</span></span>
<span class="line"><span style="color:#24292F;">app.</span><span style="color:#8250DF;">mount</span><span style="color:#24292F;">(</span><span style="color:#0A3069;">&#39;#app&#39;</span><span style="color:#24292F;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CF222E;">-------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6E7781;">// runtime-dom 包中包含了 web 平台的渲染器</span></span>
<span class="line"><span style="color:#6E7781;">// packages/runtime-dom/src/index.ts</span></span>
<span class="line"><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">createApp</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> ((</span><span style="color:#CF222E;">...</span><span style="color:#953800;">args</span><span style="color:#24292F;">) </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// 1. 创建 web 渲染器、创建 app 对象</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">app</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">ensureRenderer</span><span style="color:#24292F;">().</span><span style="color:#8250DF;">createApp</span><span style="color:#24292F;">(</span><span style="color:#CF222E;">...</span><span style="color:#24292F;">args)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> { </span><span style="color:#0550AE;">mount</span><span style="color:#24292F;"> } </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> app</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// 重写 mount 方法</span></span>
<span class="line"><span style="color:#24292F;">  app.</span><span style="color:#8250DF;">mount</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (</span><span style="color:#953800;">containerOrSelector</span><span style="color:#24292F;">) </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">container</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">normalizeContainer</span><span style="color:#24292F;">(containerOrSelector)</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 2. 调用 app.mount 核心标准方法，创建 vnode, 渲染 vnode</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#8250DF;">mount</span><span style="color:#24292F;">(container)</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// ...</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> app</span></span>
<span class="line"><span style="color:#24292F;">})</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><h4 id="渲染器-renderer" tabindex="-1"><a class="header-anchor" href="#渲染器-renderer" aria-hidden="true">#</a> 渲染器 renderer</h4><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#6E7781;">// packages/runtime-dom/src/index.ts</span></span>
<span class="line"><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">app</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">ensureRenderer</span><span style="color:#24292F;">().</span><span style="color:#8250DF;">createApp</span><span style="color:#24292F;">(</span><span style="color:#CF222E;">...</span><span style="color:#24292F;">args); </span><span style="color:#6E7781;">// 延迟创建渲染，方便 tree-shakable</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6E7781;">// 创建自定义渲染器</span></span>
<span class="line"><span style="color:#6E7781;">// vue 为了跨平台支持，抽象标准化渲染器的平台渲染接口。</span></span>
<span class="line"><span style="color:#6E7781;">// renderer = createRenderer(nodeOps)</span></span>
<span class="line"><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">ensureRenderer</span><span style="color:#24292F;">() {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> (</span></span>
<span class="line"><span style="color:#24292F;">    renderer </span><span style="color:#CF222E;">||</span><span style="color:#24292F;"> ((renderer </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> createRenderer </span><span style="color:#CF222E;">&lt;</span><span style="color:#24292F;"> Node), Element </span><span style="color:#CF222E;">&gt;</span><span style="color:#24292F;"> rendererOptions)</span></span>
<span class="line"><span style="color:#24292F;">  );</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6E7781;">// 实现不同平台的渲染操作接口</span></span>
<span class="line"><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">rendererOptions</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">extend</span><span style="color:#24292F;">({ patchProp, forcePatchProp }, nodeOps);</span></span>
<span class="line"></span></code></pre></div><p>nodeOps(packages/runtime-dom/src/nodeOps.ts)，实现了 web 平台下的渲染接口。通过创建自定义渲染器我们可以实现不同平台下的渲染。</p><p><img src="/assets/img/ed6e1c8d4a17343bfaba663aeead7351695e7aab510b56a6a390153715c25438.87a59aee.png" alt="图 2"></p><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#6E7781;">// packages/runtime-core/src/renderer.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6E7781;">// createRenderer 是 vue 自定义渲染器的核心方法</span></span>
<span class="line"><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">createRenderer</span><span style="color:#24292F;">(</span><span style="color:#953800;">nodeOps</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">baseCreateRenderer</span><span style="color:#24292F;">(nodeOps);</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">baseCreateRenderer</span><span style="color:#24292F;">(</span><span style="color:#953800;">nodeOps</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">//接口定义</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">remove</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">RemoveFn</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (</span><span style="color:#953800;">vnode</span><span style="color:#24292F;">) </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 接口调用</span></span>
<span class="line"><span style="color:#24292F;">    nodeOps.</span><span style="color:#8250DF;">remove</span><span style="color:#24292F;">();</span></span>
<span class="line"><span style="color:#24292F;">  };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">//...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// 利用闭包，将 nodeOps 保存下来</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">render</span><span style="color:#24292F;">(</span><span style="color:#953800;">vnode</span><span style="color:#24292F;">, </span><span style="color:#953800;">container</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 组件渲染的核心逻辑</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#8250DF;">patch</span><span style="color:#24292F;">(vnode, container);</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// 返回包含 render 方法的渲染器</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">    render,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// createAppAPI 创建 createApp</span></span>
<span class="line"><span style="color:#24292F;">    createApp: </span><span style="color:#8250DF;">createAppAPI</span><span style="color:#24292F;">(render),</span></span>
<span class="line"><span style="color:#24292F;">  };</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span></code></pre></div><p>除了将渲染器跨平台渲染标准化，还将应用创建流程也标准化。</p><h4 id="createappapi" tabindex="-1"><a class="header-anchor" href="#createappapi" aria-hidden="true">#</a> createAppAPI</h4><p>相比以前使用插件、挂载全局属性方法都落到 Vue 构造函数和原型上，createApp 创建一个应用上下文，允许我们创建多个 vue 应用并进行全局配置隔离。</p><p>createApp 函数内部的 app.mount 方法是一个标准的跨平台的组件渲染流程：<strong>先创建 vnode，再渲染 vnode，生成 DOM</strong>。</p><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#6E7781;">// Vue.js 利用闭包和函数柯里化，createAppAPI 包装 render</span></span>
<span class="line"><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">createAppAPI</span><span style="color:#24292F;">(</span><span style="color:#953800;">render</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// createApp createApp 方法接受的两个参数：根组件的对象和 prop</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">createApp</span><span style="color:#24292F;">(</span><span style="color:#953800;">rootComponent</span><span style="color:#24292F;">, </span><span style="color:#953800;">rootProps</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">app</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">      _component: rootComponent,</span></span>
<span class="line"><span style="color:#24292F;">      _props: rootProps,</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#8250DF;">mount</span><span style="color:#24292F;">(</span><span style="color:#953800;">rootContainer</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#6E7781;">// 创建根组件的 vnode</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">vnode</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">createVNode</span><span style="color:#24292F;">(rootComponent, rootProps);</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#6E7781;">// 调用渲染器的 render vnode</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#8250DF;">render</span><span style="color:#24292F;">(vnode, rootContainer);</span></span>
<span class="line"><span style="color:#24292F;">        app._container </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> rootContainer;</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> vnode.component.proxy;</span></span>
<span class="line"><span style="color:#24292F;">      },</span></span>
<span class="line"><span style="color:#24292F;">    };</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> app;</span></span>
<span class="line"><span style="color:#24292F;">  };</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span></code></pre></div><p>这里的代码的执行逻辑都是与平台无关的，启动标准渲染流程。如果有需要可以在外部重写这个方法，来完善特定平台下的渲染逻辑。</p><p>比如 web 平台：</p><div class="language-typescript ext-ts"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#6E7781;">// packages/runtime-dom/src/index.ts</span></span>
<span class="line"><span style="color:#CF222E;">const</span><span style="color:#24292F;"> { </span><span style="color:#0550AE;">mount</span><span style="color:#24292F;"> } </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> app</span></span>
<span class="line"><span style="color:#24292F;">  app.</span><span style="color:#8250DF;">mount</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (</span><span style="color:#953800;">containerOrSelector</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">Element</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#953800;">ShadowRoot</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">string</span><span style="color:#24292F;">)</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">any</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 标准化 root el 获取</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">container</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">normalizeContainer</span><span style="color:#24292F;">(containerOrSelector)</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (</span><span style="color:#CF222E;">!</span><span style="color:#24292F;">container) </span><span style="color:#CF222E;">return</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">component</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> app._component</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 支持 html root 元素作为 template</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (</span><span style="color:#CF222E;">!</span><span style="color:#8250DF;">isFunction</span><span style="color:#24292F;">(component) </span><span style="color:#CF222E;">&amp;&amp;</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">!</span><span style="color:#24292F;">component.render </span><span style="color:#CF222E;">&amp;&amp;</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">!</span><span style="color:#24292F;">component.template) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// __UNSAFE__</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// Reason: potential execution of JS expressions in in-DOM template.</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// The user must make sure the in-DOM template is trusted. If it&#39;s</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// rendered by the server, the template should not contain any user data.</span></span>
<span class="line"><span style="color:#24292F;">      component.template </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> container.innerHTML</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// clear content before mounting</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 清除 root 内容</span></span>
<span class="line"><span style="color:#24292F;">    container.innerHTML </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0A3069;">&#39;&#39;</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">proxy</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">mount</span><span style="color:#24292F;">(container, </span><span style="color:#0550AE;">false</span><span style="color:#24292F;">, container </span><span style="color:#CF222E;">instanceof</span><span style="color:#24292F;"> </span><span style="color:#953800;">SVGElement</span><span style="color:#24292F;">)</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (container </span><span style="color:#CF222E;">instanceof</span><span style="color:#24292F;"> </span><span style="color:#953800;">Element</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">      container.</span><span style="color:#8250DF;">removeAttribute</span><span style="color:#24292F;">(</span><span style="color:#0A3069;">&#39;v-cloak&#39;</span><span style="color:#24292F;">)</span></span>
<span class="line"><span style="color:#24292F;">      container.</span><span style="color:#8250DF;">setAttribute</span><span style="color:#24292F;">(</span><span style="color:#0A3069;">&#39;data-v-app&#39;</span><span style="color:#24292F;">, </span><span style="color:#0A3069;">&#39;&#39;</span><span style="color:#24292F;">)</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> proxy</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"></span></code></pre></div><p>进入应用挂载阶段后，接下来就是核心的组件渲染流程。</p><h3 id="组件渲染" tabindex="-1"><a class="header-anchor" href="#组件渲染" aria-hidden="true">#</a> 组件渲染</h3><h4 id="创建-vnode" tabindex="-1"><a class="header-anchor" href="#创建-vnode" aria-hidden="true">#</a> 创建 vnode</h4><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#6E7781;">// packages/runtime-core/src/vnode.ts</span></span>
<span class="line"><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">_createVNode</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">type</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNodeTypes</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#953800;">ClassComponent</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">typeof</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">NULL_DYNAMIC_COMPONENT</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">props</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> (</span><span style="color:#953800;">Data</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">&amp;</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNodeProps</span><span style="color:#24292F;">) </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">children</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">unknown</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">patchFlag</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">number</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">0</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">dynamicProps</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">string</span><span style="color:#24292F;">[] </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">isBlockNode</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">false</span></span>
<span class="line"><span style="color:#24292F;">)</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (props) {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 处理 props 相关逻辑，标准化 class 和 style</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// 对 vnode 类型信息编码</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// 以便在后面的 patch 阶段，可以根据不同的类型执行相应的处理逻辑</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">shapeFlag</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">isString</span><span style="color:#24292F;">(type)</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">?</span><span style="color:#24292F;"> ShapeFlags.</span><span style="color:#0550AE;">ELEMENT</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> __FEATURE_SUSPENSE__ </span><span style="color:#CF222E;">&amp;&amp;</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">isSuspense</span><span style="color:#24292F;">(type)</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">?</span><span style="color:#24292F;"> ShapeFlags.</span><span style="color:#0550AE;">SUSPENSE</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">isTeleport</span><span style="color:#24292F;">(type)</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">?</span><span style="color:#24292F;"> ShapeFlags.</span><span style="color:#0550AE;">TELEPORT</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">isObject</span><span style="color:#24292F;">(type)</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#CF222E;">?</span><span style="color:#24292F;"> ShapeFlags.</span><span style="color:#0550AE;">STATEFUL_COMPONENT</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">isFunction</span><span style="color:#24292F;">(type)</span></span>
<span class="line"><span style="color:#24292F;">            </span><span style="color:#CF222E;">?</span><span style="color:#24292F;"> ShapeFlags.</span><span style="color:#0550AE;">FUNCTIONAL_COMPONENT</span></span>
<span class="line"><span style="color:#24292F;">            </span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">vnode</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">    type,</span></span>
<span class="line"><span style="color:#24292F;">    props,</span></span>
<span class="line"><span style="color:#24292F;">    key: props </span><span style="color:#CF222E;">&amp;&amp;</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">normalizeKey</span><span style="color:#24292F;">(props),</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">...</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// 标准化子节点，把不同数据类型的 children 转成数组或者文本类型</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#8250DF;">normalizeChildren</span><span style="color:#24292F;">(vnode, children)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> vnode</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span></code></pre></div><p>工厂模式创建 vnode，并且对 props、children 做标准化处理、对 vnode 的 type、children 做信息编码，以便在后面可以根据不同的类型执行相应的处理逻辑。</p><h4 id="渲染-vnode-patch-vnode" tabindex="-1"><a class="header-anchor" href="#渲染-vnode-patch-vnode" aria-hidden="true">#</a> 渲染 vnode（patch vnode）</h4><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">render</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">RootRenderFunction</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (</span><span style="color:#953800;">vnode</span><span style="color:#24292F;">, </span><span style="color:#953800;">container</span><span style="color:#24292F;">, </span><span style="color:#953800;">isSVG</span><span style="color:#24292F;">) </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (vnode </span><span style="color:#CF222E;">==</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 销毁组件</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (container._vnode) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#8250DF;">unmount</span><span style="color:#24292F;">(container._vnode, </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">, </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">, </span><span style="color:#0550AE;">true</span><span style="color:#24292F;">);</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">  } </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 创建或者更新组件</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#8250DF;">patch</span><span style="color:#24292F;">(container._vnode </span><span style="color:#CF222E;">||</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">, vnode, container, </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">, </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">, </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">, isSVG);</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// 缓存 vnode 节点，表示已经渲染</span></span>
<span class="line"><span style="color:#24292F;">  container._vnode </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> vnode;</span></span>
<span class="line"><span style="color:#24292F;">};</span></span>
<span class="line"></span></code></pre></div><p>patch 会根据不同的 vnode 类型派发任务给 process 处理。但初始渲染时旧 vnode 为 null，最终处理结果基本是 mount 操作:</p><p><code>diff type =&gt; process =&gt; mount</code></p><p>比如根 vnode 是个组件类型，故 processComponent 进行处理，调用 mountComponent 方法渲染组件。</p><div class="language-typescript ext-ts"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">patch</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">PatchFn</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">n1</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">n2</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">container</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    anchor </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    parentComponent </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    parentSuspense </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    isSVG </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">false</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    slotScopeIds </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    optimized </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">false</span></span>
<span class="line"><span style="color:#24292F;">  ) </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 如果存在新旧节点, 且新旧节点类型不同，则销毁旧节点</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (n1 </span><span style="color:#CF222E;">&amp;&amp;</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">!</span><span style="color:#8250DF;">isSameVNodeType</span><span style="color:#24292F;">(n1, n2)) {</span></span>
<span class="line"><span style="color:#24292F;">      anchor </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">getNextHostNode</span><span style="color:#24292F;">(n1)</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#8250DF;">unmount</span><span style="color:#24292F;">(n1, parentComponent, parentSuspense, </span><span style="color:#0550AE;">true</span><span style="color:#24292F;">)</span></span>
<span class="line"><span style="color:#24292F;">      n1 </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> { </span><span style="color:#0550AE;">type</span><span style="color:#24292F;">, </span><span style="color:#0550AE;">ref</span><span style="color:#24292F;">, </span><span style="color:#0550AE;">shapeFlag</span><span style="color:#24292F;"> } </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> n2</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">switch</span><span style="color:#24292F;"> (type) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">case</span><span style="color:#24292F;"> Text:</span><span style="color:#CF222E;">...</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">case</span><span style="color:#24292F;"> Comment:</span><span style="color:#CF222E;">...</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">case</span><span style="color:#24292F;"> Static:</span><span style="color:#CF222E;">...</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">case</span><span style="color:#24292F;"> Fragment:</span><span style="color:#CF222E;">...</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">default</span><span style="color:#24292F;">:</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (shapeFlag </span><span style="color:#CF222E;">&amp;</span><span style="color:#24292F;"> ShapeFlags.</span><span style="color:#0550AE;">ELEMENT</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">         </span><span style="color:#CF222E;">...</span></span>
<span class="line"><span style="color:#24292F;">        } </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (shapeFlag </span><span style="color:#CF222E;">&amp;</span><span style="color:#24292F;"> ShapeFlags.</span><span style="color:#0550AE;">COMPONENT</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#8250DF;">processComponent</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">            n1,</span></span>
<span class="line"><span style="color:#24292F;">            n2,</span></span>
<span class="line"><span style="color:#24292F;">            container,</span></span>
<span class="line"><span style="color:#24292F;">            anchor,</span></span>
<span class="line"><span style="color:#24292F;">            parentComponent,</span></span>
<span class="line"><span style="color:#24292F;">            parentSuspense,</span></span>
<span class="line"><span style="color:#24292F;">            isSVG,</span></span>
<span class="line"><span style="color:#24292F;">            slotScopeIds,</span></span>
<span class="line"><span style="color:#24292F;">            optimized</span></span>
<span class="line"><span style="color:#24292F;">          )</span></span>
<span class="line"><span style="color:#24292F;">        } </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (shapeFlag </span><span style="color:#CF222E;">&amp;</span><span style="color:#24292F;"> ShapeFlags.</span><span style="color:#0550AE;">TELEPORT</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#CF222E;">...</span></span>
<span class="line"><span style="color:#24292F;">        } </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (__FEATURE_SUSPENSE__ </span><span style="color:#CF222E;">&amp;&amp;</span><span style="color:#24292F;"> shapeFlag </span><span style="color:#CF222E;">&amp;</span><span style="color:#24292F;"> ShapeFlags.</span><span style="color:#0550AE;">SUSPENSE</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">         </span><span style="color:#CF222E;">...</span></span>
<span class="line"><span style="color:#24292F;">        } </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (__DEV__) {</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#CF222E;">...</span></span>
<span class="line"><span style="color:#24292F;">        }</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">processComponent</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (</span><span style="color:#953800;">n1</span><span style="color:#24292F;">, </span><span style="color:#953800;">n2</span><span style="color:#24292F;">, </span><span style="color:#953800;">container</span><span style="color:#24292F;">, </span><span style="color:#953800;">anchor</span><span style="color:#24292F;">, </span><span style="color:#953800;">parentComponent</span><span style="color:#24292F;">, </span><span style="color:#953800;">parentSuspense</span><span style="color:#24292F;">, </span><span style="color:#953800;">isSVG</span><span style="color:#24292F;">, </span><span style="color:#953800;">optimized</span><span style="color:#24292F;">) </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (n1 </span><span style="color:#CF222E;">==</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">   </span><span style="color:#6E7781;">// 挂载组件</span></span>
<span class="line"><span style="color:#24292F;">   </span><span style="color:#8250DF;">mountComponent</span><span style="color:#24292F;">(n2, container, anchor, parentComponent, parentSuspense, isSVG, optimized)</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 更新组件</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#8250DF;">updateComponent</span><span style="color:#24292F;">(n1, n2, parentComponent, optimized)</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6E7781;">// 挂载组件</span></span>
<span class="line"><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">mountComponent</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (</span><span style="color:#953800;">initialVNode</span><span style="color:#24292F;">, </span><span style="color:#953800;">container</span><span style="color:#24292F;">, </span><span style="color:#953800;">anchor</span><span style="color:#24292F;">, </span><span style="color:#953800;">parentComponent</span><span style="color:#24292F;">, </span><span style="color:#953800;">parentSuspense</span><span style="color:#24292F;">, </span><span style="color:#953800;">isSVG</span><span style="color:#24292F;">, </span><span style="color:#953800;">optimized</span><span style="color:#24292F;">) </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// 创建组件实例</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">instance</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (initialVNode.component </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">createComponentInstance</span><span style="color:#24292F;">(initialVNode, parentComponent, parentSuspense))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// 初始化 Props、Slots、调用 setup 初始状态</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#8250DF;">setupComponent</span><span style="color:#24292F;">(instance)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// 设置并运行渲染副作用</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#8250DF;">setupRenderEffect</span><span style="color:#24292F;">(instance, initialVNode, container, anchor, parentSuspense, isSVG, optimized)</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span></code></pre></div><p><code>mountComponent</code> 方法渲染组件中最主要的是 <code>setupRenderEffect</code>，<strong>该函数利用响应式库的 effect 函数创建了一个组件的渲染副作用。在响应式系统下，当组件的数据发生变化时，effect 函数包裹的组件渲染函数会重新执行一遍，从而达到重新渲染组件的目的</strong>。</p><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">setupRenderEffect</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">instance</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">initialVNode</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">container</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">anchor</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">parentSuspense</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">isSVG</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">optimized</span></span>
<span class="line"><span style="color:#24292F;">) </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// 创建响应式的副作用渲染函数</span></span>
<span class="line"><span style="color:#24292F;">  instance.update </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">effect</span><span style="color:#24292F;">(</span><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">componentEffect</span><span style="color:#24292F;">() {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (</span><span style="color:#CF222E;">!</span><span style="color:#24292F;">instance.isMounted) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// 调用组件的 render 方法，生成 subTree</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">subTree</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (instance.subTree </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">renderComponentRoot</span><span style="color:#24292F;">(instance));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// patch subTree</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#8250DF;">patch</span><span style="color:#24292F;">(</span><span style="color:#0550AE;">null</span><span style="color:#24292F;">, subTree, container, anchor, instance, parentSuspense, isSVG);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// 保留渲染生成的子树根 DOM 节点</span></span>
<span class="line"><span style="color:#24292F;">      initialVNode.el </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> subTree.el;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">      instance.isMounted </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">true</span><span style="color:#24292F;">;</span></span>
<span class="line"><span style="color:#24292F;">    } </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// 更新组件</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">  }, prodEffectOptions);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// 初始渲染</span></span>
<span class="line"><span style="color:#24292F;">  instance.</span><span style="color:#8250DF;">update</span><span style="color:#24292F;">();</span></span>
<span class="line"><span style="color:#24292F;">};</span></span>
<span class="line"></span></code></pre></div><p><strong>组件在 vnode tree 中只是个抽象节点，实际渲染的是组件的 render 函数生成 subTree，故还要继续 patch subTree</strong>。</p><p>经过 patch 函数的深度递归处理，<strong>普通元素类型的节点</strong>处理才会是最终反应到页面上。</p><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#6E7781;">// patch =&gt; processElement =&gt; mountElement</span></span>
<span class="line"><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">mountElement</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">vnode</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">container</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">anchor</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">parentComponent</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">parentSuspense</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">isSVG</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">optimized</span></span>
<span class="line"><span style="color:#24292F;">) </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">let</span><span style="color:#24292F;"> el;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> { </span><span style="color:#0550AE;">type</span><span style="color:#24292F;">, </span><span style="color:#0550AE;">props</span><span style="color:#24292F;">, </span><span style="color:#0550AE;">shapeFlag</span><span style="color:#24292F;"> } </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> vnode;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// 创建 DOM 元素节点</span></span>
<span class="line"><span style="color:#24292F;">  el </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> vnode.el </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">hostCreateElement</span><span style="color:#24292F;">(vnode.type, isSVG, props </span><span style="color:#CF222E;">&amp;&amp;</span><span style="color:#24292F;"> props.is);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (props) {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 处理 props，比如 class、style、event 等属性</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">for</span><span style="color:#24292F;"> (</span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">key</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">in</span><span style="color:#24292F;"> props) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (</span><span style="color:#CF222E;">!</span><span style="color:#8250DF;">isReservedProp</span><span style="color:#24292F;">(key)) {</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#8250DF;">hostPatchProp</span><span style="color:#24292F;">(el, key, </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">, props[key], isSVG);</span></span>
<span class="line"><span style="color:#24292F;">      }</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (shapeFlag </span><span style="color:#CF222E;">&amp;</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">8</span><span style="color:#24292F;"> </span><span style="color:#6E7781;">/* TEXT_CHILDREN */</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 处理子节点是纯文本的情况</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#8250DF;">hostSetElementText</span><span style="color:#24292F;">(el, vnode.children);</span></span>
<span class="line"><span style="color:#24292F;">  } </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (shapeFlag </span><span style="color:#CF222E;">&amp;</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">16</span><span style="color:#24292F;"> </span><span style="color:#6E7781;">/* ARRAY_CHILDREN */</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 处理子节点是数组的情况</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#8250DF;">mountChildren</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">      vnode.children,</span></span>
<span class="line"><span style="color:#24292F;">      el,</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">      parentComponent,</span></span>
<span class="line"><span style="color:#24292F;">      parentSuspense,</span></span>
<span class="line"><span style="color:#24292F;">      isSVG </span><span style="color:#CF222E;">&amp;&amp;</span><span style="color:#24292F;"> type </span><span style="color:#CF222E;">!==</span><span style="color:#24292F;"> </span><span style="color:#0A3069;">&quot;foreignObject&quot;</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">      optimized </span><span style="color:#CF222E;">||</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">!!</span><span style="color:#24292F;">vnode.dynamicChildren</span></span>
<span class="line"><span style="color:#24292F;">    );</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// 把创建的 DOM 元素节点挂载到 container 上</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#8250DF;">hostInsert</span><span style="color:#24292F;">(el, container, anchor);</span></span>
<span class="line"><span style="color:#24292F;">};</span></span>
<span class="line"></span></code></pre></div><p><strong>在 mountElement 方法调用平台渲染方法，比如 <code>hostCreateElement</code>，在 web 平台底层就是调用 <code>document.createElement</code> 方法</strong>。</p><p>深度递归 vnode tree 的过程，<strong>挂载的顺序是先子节点，后父节点，最终挂载到最外层的容器上</strong>，完成整个渲染流程。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><ol><li>创建应用 createApp，可以让我们进行应用环境隔离</li><li>组件 vnode 是抽象节点，是不会生成真实节点，调用组件模板生成 subTree 去渲染</li><li>元素类型的节点才会最终落实渲染成真实 DOM 节点</li><li>VirtualDOM 的渲染机制就是深度递归 diff 新旧 vnode tree 差异并调用平台的渲染接口，生成真实的 DOM</li></ol><blockquote><p>下图为 vue 渲染流程，其中更新流程也包括在里面</p></blockquote><p><img src="/assets/img/089ea60df2fe1490c5fb0c69e460a9681c509346e0486d52a95d131902cbbc92.7d6fc3a3.png" alt="图 6"></p><p>下篇 <a href="/Vue/diff%20%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B.html" class="">diff 更新流程</a>。</p></div><!----></article></div><footer class="footer footer-center p-4 bg-base-300 text-base-content opacity-60"><div><p>©2017-2021 laoergege.cn. All right reserved. </p><p><a href="https://beian.miit.gov.cn" target="_blank" class="link link-hover">粤ICP备2022020679号</a></p></div></footer><!--]--><!----><!--]--></div>
    <script src="/assets/js/runtime~app.7d4bd660.js" defer></script><script src="/assets/js/5838.13a569e5.js" defer></script><script src="/assets/js/app.7e792774.js" defer></script>
</body>

</html>