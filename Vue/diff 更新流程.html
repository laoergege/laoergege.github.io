<!DOCTYPE html>
<html lang="zh-CN" data-theme="cupcake">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.46">
    <link rel="manifest" href="/site.webmanifest.json"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><title>diff 更新流程 | </title><meta name="description" content="Just For Fun">
    <link rel="preload" href="/assets/js/runtime~app.7d4bd660.js" as="script"><link rel="preload" href="/assets/css/styles.1c65b737.css" as="style"><link rel="preload" href="/assets/js/5838.13a569e5.js" as="script"><link rel="preload" href="/assets/js/app.7e792774.js" as="script"><link rel="prefetch" href="/assets/js/v-03fc2322.47d94022.js"><link rel="prefetch" href="/assets/js/v-ba2c1988.3632b5e0.js"><link rel="prefetch" href="/assets/js/v-fd8e5af2.a9cafb88.js"><link rel="prefetch" href="/assets/js/v-5a071f34.190f1fdc.js"><link rel="prefetch" href="/assets/js/v-317472f1.a3c9dba2.js"><link rel="prefetch" href="/assets/js/v-560b844b.09f8a065.js"><link rel="prefetch" href="/assets/js/v-85bc3e4c.27575d9e.js"><link rel="prefetch" href="/assets/js/v-4835f72d.209f9a9b.js"><link rel="prefetch" href="/assets/js/v-6f2abf9c.c6a52b82.js"><link rel="prefetch" href="/assets/js/v-32c68258.46247de2.js"><link rel="prefetch" href="/assets/js/v-04983e79.ae40370a.js"><link rel="prefetch" href="/assets/js/v-7269d92e.00653b56.js"><link rel="prefetch" href="/assets/js/v-54e51afe.e3f20358.js"><link rel="prefetch" href="/assets/js/v-5fbdabee.afcc17b5.js"><link rel="prefetch" href="/assets/js/v-928f5a14.0a4a3dc4.js"><link rel="prefetch" href="/assets/js/v-88c7f226.529f6212.js"><link rel="prefetch" href="/assets/js/v-5e99732b.68dd2407.js"><link rel="prefetch" href="/assets/js/v-2fc78b4d.97b37f50.js"><link rel="prefetch" href="/assets/js/v-d99bba28.2cf82742.js"><link rel="prefetch" href="/assets/js/v-bee2f4a8.f072eb83.js"><link rel="prefetch" href="/assets/js/v-57ad8616.44af159f.js"><link rel="prefetch" href="/assets/js/v-f701b528.aa7f8f17.js"><link rel="prefetch" href="/assets/js/v-093d016d.bc725dd1.js"><link rel="prefetch" href="/assets/js/v-06ed95cc.0db5595a.js"><link rel="prefetch" href="/assets/js/v-01b20944.db789013.js"><link rel="prefetch" href="/assets/js/v-137d7552.50039c10.js"><link rel="prefetch" href="/assets/css/5045.styles.72ac531f.css"><link rel="prefetch" href="/assets/js/v-631fc68a.80740d81.js"><link rel="prefetch" href="/assets/js/v-8b5f7690.191ba9a3.js"><link rel="prefetch" href="/assets/js/v-530f22f6.f8e361fa.js"><link rel="prefetch" href="/assets/js/v-be2646cc.549f65bf.js"><link rel="prefetch" href="/assets/js/v-75e44f07.2f8601c3.js"><link rel="prefetch" href="/assets/js/v-c2504efe.28c55f92.js"><link rel="prefetch" href="/assets/js/v-5bc51cd9.b23c2caa.js"><link rel="prefetch" href="/assets/js/5956.f176ea33.js"><link rel="prefetch" href="/assets/js/v-6dc8e518.a8181c32.js"><link rel="prefetch" href="/assets/js/v-568d3b89.483d19f1.js"><link rel="prefetch" href="/assets/js/v-743faa02.3247db36.js"><link rel="prefetch" href="/assets/js/v-d52c6cc0.34d4b256.js"><link rel="prefetch" href="/assets/js/v-78263bfa.b7cb21e4.js"><link rel="prefetch" href="/assets/js/v-199de1f8.16ad6f91.js"><link rel="prefetch" href="/assets/js/v-30078430.3079f1d2.js"><link rel="prefetch" href="/assets/js/v-240dbb06.02e786fb.js"><link rel="prefetch" href="/assets/js/v-7a102f72.94a1b7e7.js"><link rel="prefetch" href="/assets/js/v-1402111c.9dc8cc11.js"><link rel="prefetch" href="/assets/js/v-f2bbc8da.fc4d9aa5.js"><link rel="prefetch" href="/assets/js/v-b0176dc2.b994ff0c.js"><link rel="prefetch" href="/assets/js/4644.1787b6ff.js"><link rel="prefetch" href="/assets/js/v-a5da5a08.cc633de8.js"><link rel="prefetch" href="/assets/js/v-acadbc84.800a32fa.js"><link rel="prefetch" href="/assets/js/v-a270a8ca.ea9c331c.js"><link rel="prefetch" href="/assets/js/v-a9440b46.63ee3544.js"><link rel="prefetch" href="/assets/js/6929.46233b49.js"><link rel="prefetch" href="/assets/js/9840.789f773b.js"><link rel="prefetch" href="/assets/js/v-9f06f78c.ff18832e.js"><link rel="prefetch" href="/assets/js/9870.c84a31ac.js"><link rel="prefetch" href="/assets/js/v-8daa1a0e.8245b191.js"><link rel="prefetch" href="/sw.js"><link rel="prefetch" href="/assets/css/3859.styles.7057c730.css">
    <link rel="stylesheet" href="/assets/css/styles.1c65b737.css">
</head>

<body>
    <div id="app"><!--[--><!--[--><div class="navbar sticky top-0 z-10"><a href="/" class=""><label class="btn btn-circle avatar"><div class="rounded-full ring ring-white shadow-2xl no-zoom"><img src="/avatar.webp"></div></label></a></div><div class="min-h-screen flex justify-center flex-col items-center"><article class="article w-full sm:w-3/4 lg:w-2/3 p-4" data-theme="cupcake"><div class="sm:max-w-full pb-12 prose sm:prose-sm md:prose-lg dark:prose-invert"><h1 id="diff-更新流程" tabindex="-1"><a class="header-anchor" href="#diff-更新流程" aria-hidden="true">#</a> diff 更新流程</h1><blockquote><p>以下示例代码基于 vue3.2 版本</p></blockquote><p>在 Vue 中，页面是由组件构成的树形结构，整个组件树的 vnode tree 结构如下：</p><p><img src="/assets/img/b130a506b4998e0a5143175af337c9a7eb9a8b2fb9356d698522f5e3f9d9e1e8.7e2cc1c5.png" alt="图 4"></p><p>Vue 的更新粒度是组件级的，当数据变化的时候就会执行组件的渲染副作用来触发组件的更新。页面更新的本质就是递归 diff 新旧 vnode 的差异变化再去调用对应平台的渲染操作相关的 API。</p><h2 id="组件更新流程" tabindex="-1"><a class="header-anchor" href="#组件更新流程" aria-hidden="true">#</a> 组件更新流程</h2><p>一个组件重新渲染可能会有两种场景：</p><ul><li>组件 state 发生变更</li><li>组件 props 发生变更</li></ul><p>渲染副作用会重新执行。</p><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#6E7781;">// packages/runtime-core/src/renderer.ts</span></span>
<span class="line"><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">setupRenderEffect</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">SetupRenderEffectFn</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">instance</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">initialVNode</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">container</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">anchor</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">parentSuspense</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">isSVG</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">optimized</span></span>
<span class="line"><span style="color:#24292F;">  ) </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">componentUpdateFn</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> () </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (</span><span style="color:#CF222E;">!</span><span style="color:#24292F;">instance.isMounted) {</span></span>
<span class="line"><span style="color:#24292F;">       </span><span style="color:#6E7781;">// 初次渲染</span></span>
<span class="line"><span style="color:#24292F;">      } </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#6E7781;">// 更新渲染</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#6E7781;">// next 表示新的组件 vnode</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">let</span><span style="color:#24292F;"> { next, bu, u, parent, vnode } </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> instance</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">let</span><span style="color:#24292F;"> originNext </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> next</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#6E7781;">// next 代表为新组件的 vnode，组件实例需更新对应的 vnode。</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#6E7781;">// 1. 当组件 state 发生变更（next: null）</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#6E7781;">// 2. 当组件 props 发生变更（next: vnode）  </span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (next) {</span></span>
<span class="line"><span style="color:#24292F;">          next.el </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> vnode.el</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#6E7781;">// 更新组件 vnode 节点信息</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#6E7781;">// 主要是更改组件实例的 vnode 指针、updateProps、updateSlots</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#8250DF;">updateComponentPreRender</span><span style="color:#24292F;">(instance, next, optimized)</span></span>
<span class="line"><span style="color:#24292F;">        } </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">          next </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> vnode</span></span>
<span class="line"><span style="color:#24292F;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#6E7781;">// 新子树</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">nextTree</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">renderComponentRoot</span><span style="color:#24292F;">(instance)</span></span>
<span class="line"><span style="color:#24292F;">        </span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">prevTree</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> instance.subTree</span></span>
<span class="line"><span style="color:#24292F;">        instance.subTree </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> nextTree</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#6E7781;">// diff 新旧子树</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#8250DF;">patch</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">          prevTree,</span></span>
<span class="line"><span style="color:#24292F;">          nextTree,</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#6E7781;">// parent may have changed if it&#39;s in a teleport</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#8250DF;">hostParentNode</span><span style="color:#24292F;">(prevTree.el</span><span style="color:#CF222E;">!</span><span style="color:#24292F;">)</span><span style="color:#CF222E;">!</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#6E7781;">// anchor may have changed if it&#39;s in a fragment</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#8250DF;">getNextHostNode</span><span style="color:#24292F;">(prevTree),</span></span>
<span class="line"><span style="color:#24292F;">          instance,</span></span>
<span class="line"><span style="color:#24292F;">          parentSuspense,</span></span>
<span class="line"><span style="color:#24292F;">          isSVG</span></span>
<span class="line"><span style="color:#24292F;">        )</span></span>
<span class="line"><span style="color:#24292F;">        </span></span>
<span class="line"><span style="color:#24292F;">        next.el </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> nextTree.el</span></span>
<span class="line"><span style="color:#24292F;">      }</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">//...</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"></span></code></pre></div><p>组件的更新渲染主要任务：</p><ol><li>更新组件实例的 vnode、props、slots 等信息</li><li>生成新的 subTree</li><li>diff 新旧 subTree</li></ol><p>递归 patch 过程，父组件对子组件的更新处理：</p><div class="language-typescript ext-ts"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// processComponent =&gt; updateComponent</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">updateComponent</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (</span><span style="color:#953800;">n1</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;">, </span><span style="color:#953800;">n2</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;">, </span><span style="color:#953800;">optimized</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">boolean</span><span style="color:#24292F;">) </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">instance</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (n2.component </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> n1.component)</span><span style="color:#CF222E;">!</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// shouldUpdateComponent 函数的内部，主要是通过检测和对比组件 vnode 的 props</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (</span><span style="color:#8250DF;">shouldUpdateComponent</span><span style="color:#24292F;">(n1, n2, optimized)) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">//...</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#6E7781;">// normal update</span></span>
<span class="line"><span style="color:#24292F;">        instance.next </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> n2</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#6E7781;">// 去除子组件的渲染任务，防止重复更新</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#8250DF;">invalidateJob</span><span style="color:#24292F;">(instance.update)</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#6E7781;">// 子组件更新</span></span>
<span class="line"><span style="color:#24292F;">        instance.</span><span style="color:#8250DF;">update</span><span style="color:#24292F;">()</span></span>
<span class="line"><span style="color:#24292F;">      }</span></span>
<span class="line"><span style="color:#24292F;">    } else {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// no update needed. just copy over properties</span></span>
<span class="line"><span style="color:#24292F;">      n2.component </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> n1.component</span></span>
<span class="line"><span style="color:#24292F;">      n2.el </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> n1.el</span></span>
<span class="line"><span style="color:#24292F;">      instance.vnode </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> n2</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"></span></code></pre></div><p>子组件是否需要更新通过 <code>shouldUpdateComponent</code> 判断。</p><div class="language-typescript ext-ts"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#6E7781;">// packages/runtime-core/src/componentRenderUtils.ts</span></span>
<span class="line"><span style="color:#CF222E;">export</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">shouldUpdateComponent</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">prevVNode</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">nextVNode</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">optimized</span><span style="color:#CF222E;">?:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">boolean</span></span>
<span class="line"><span style="color:#24292F;">)</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">boolean</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> { </span><span style="color:#953800;">props</span><span style="color:#24292F;">: </span><span style="color:#0550AE;">prevProps</span><span style="color:#24292F;">, </span><span style="color:#953800;">children</span><span style="color:#24292F;">: </span><span style="color:#0550AE;">prevChildren</span><span style="color:#24292F;">, </span><span style="color:#0550AE;">component</span><span style="color:#24292F;"> } </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> prevVNode</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> { </span><span style="color:#953800;">props</span><span style="color:#24292F;">: </span><span style="color:#0550AE;">nextProps</span><span style="color:#24292F;">, </span><span style="color:#953800;">children</span><span style="color:#24292F;">: </span><span style="color:#0550AE;">nextChildren</span><span style="color:#24292F;">, </span><span style="color:#0550AE;">patchFlag</span><span style="color:#24292F;"> } </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> nextVNode</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">emits</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> component</span><span style="color:#CF222E;">!</span><span style="color:#24292F;">.emitsOptions</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// force child update for runtime directive or transition on component vnode.</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (nextVNode.dirs </span><span style="color:#CF222E;">||</span><span style="color:#24292F;"> nextVNode.transition) {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">true</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (optimized </span><span style="color:#CF222E;">&amp;&amp;</span><span style="color:#24292F;"> patchFlag </span><span style="color:#CF222E;">&gt;=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">0</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 编译优化</span></span>
<span class="line"><span style="color:#24292F;">  } </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// this path is only taken by manually written render functions</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// so presence of any children leads to a forced update</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (prevChildren </span><span style="color:#CF222E;">||</span><span style="color:#24292F;"> nextChildren) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (</span><span style="color:#CF222E;">!</span><span style="color:#24292F;">nextChildren </span><span style="color:#CF222E;">||</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">!</span><span style="color:#24292F;">(nextChildren </span><span style="color:#CF222E;">as</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">any</span><span style="color:#24292F;">).$stable) {</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">true</span></span>
<span class="line"><span style="color:#24292F;">      }</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (prevProps </span><span style="color:#CF222E;">===</span><span style="color:#24292F;"> nextProps) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">false</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (</span><span style="color:#CF222E;">!</span><span style="color:#24292F;">prevProps) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">!!</span><span style="color:#24292F;">nextProps</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (</span><span style="color:#CF222E;">!</span><span style="color:#24292F;">nextProps) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">true</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">hasPropsChanged</span><span style="color:#24292F;">(prevProps, nextProps, emits)</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">false</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">hasPropsChanged</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">prevProps</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">Data</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">nextProps</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">Data</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">emitsOptions</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">ComponentInternalInstance</span><span style="color:#24292F;">[</span><span style="color:#0A3069;">&#39;emitsOptions&#39;</span><span style="color:#24292F;">]</span></span>
<span class="line"><span style="color:#24292F;">)</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">boolean</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">nextKeys</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">Object</span><span style="color:#24292F;">.</span><span style="color:#8250DF;">keys</span><span style="color:#24292F;">(nextProps)</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (nextKeys.</span><span style="color:#0550AE;">length</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">!==</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">Object</span><span style="color:#24292F;">.</span><span style="color:#8250DF;">keys</span><span style="color:#24292F;">(prevProps).</span><span style="color:#0550AE;">length</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">true</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">for</span><span style="color:#24292F;"> (</span><span style="color:#CF222E;">let</span><span style="color:#24292F;"> i </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">0</span><span style="color:#24292F;">; i </span><span style="color:#CF222E;">&lt;</span><span style="color:#24292F;"> nextKeys.</span><span style="color:#0550AE;">length</span><span style="color:#24292F;">; i</span><span style="color:#CF222E;">++</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">key</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> nextKeys[i]</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (</span></span>
<span class="line"><span style="color:#24292F;">      nextProps[key] </span><span style="color:#CF222E;">!==</span><span style="color:#24292F;"> prevProps[key] </span><span style="color:#CF222E;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">!</span><span style="color:#8250DF;">isEmitListener</span><span style="color:#24292F;">(emitsOptions, key)</span></span>
<span class="line"><span style="color:#24292F;">    ) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">true</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">false</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span></code></pre></div><blockquote><p>为了提高 diff 效率，vue 源码中还包含着许多编译优化的 case，我们先忽略这些，关注主流程。</p></blockquote><p>在非编译优化下，主要是通过检测和对比组件 vnode 中的 <strong>props、chidren、dirs、transiton</strong> 来决定子组件是否需要更新。</p><p><strong>默认情况下有 chidren、dirs、transiton 都会导致直接发生更新</strong>，而 props 的判断依据很简单：</p><ol><li>props 长度判断</li><li>基本类型做值判断</li><li>引用类型做引用判断</li></ol><p>这是很好理解的，因为在一个组件的子组件是否需要更新，我们主要依据子组件 vnode 是否存在一些会影响组件更新的属性变化进行判断，如果存在就会更新子组件。</p><p>当需要更新时，赋值新的 vnode 到 next，触发子组件的渲染副作用，并删除任务队列子组件的渲染任务防止重复更新（当一个状态发生改变可以能触发父子组件更新，父组件的更新可能会导致子组件更新，这时就要去重任务队列中的子组件渲染任务，更多了解 <a href="/Vue/vue%20%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E6%B8%B2%E6%9F%93%E6%9C%BA%E5%88%B6.html" class="">vue 的响应式渲染机制</a>）。</p><p><strong>vue 从组件树角度以组件为更新粒度，缩小了 vnode tree 的 diff 范围</strong>，更近一步提高 diff 效率，接下来了解 vue3 的 diff 算法。</p><h2 id="vue-diff-算法" tabindex="-1"><a class="header-anchor" href="#vue-diff-算法" aria-hidden="true">#</a> vue diff 算法</h2><p>diff 算法主要是关于如何高效得 diff vnode tree 之间的差异，以较低的成本（<strong>减少 DOM 操作、提高节点复用</strong>）完成子节点的更新。</p><p>理想情况（复用所有能复用的节点，实在遇到新增或删除时，才执行插入或删除）的算法的时间复杂度 O(n³) 无法接受。</p><blockquote><p>关于 O(n³) 的由来。由于左树中任意节点都可能出现在右树，所以必须在对左树深度遍历的同时，对右树进行深度遍历，找到每个节点的对应关系，这里的时间复杂度是 O(n²)，之后需要对树的各节点进行增删移的操作，这个过程简单可以理解为加了一层遍历循环，因此再乘一个 n。</p></blockquote><p>优化后的算法主要有三点：</p><ol><li>根据 type &amp; key 去判断是否为相同节点 <ol><li>如果是同一类型则继续比较更新</li><li>如果不是则重新销毁创建新的节点</li></ol></li><li>只在同层比较（根据启发跨层 DOM 复用在实际业务场景中很少出现）</li><li>同层节点采用 “<strong>去头尾的最长递增子序列算法</strong>” 进行比较</li></ol><p>同层节点比较可能出现的三种操作情况：增、删、移；而对于一个 vnode 的 children 类型可能会有三种情况：纯文本、vnode 数组和空。那么就有以下不同的类型组合操作有：</p><ul><li>旧：空 <ul><li>新：空</li><li>新：文本 <ul><li>挂载文本节点</li></ul></li><li>新：数组 <ul><li>挂载数组节点</li></ul></li></ul></li><li>旧：文本 <ul><li>新：空 <ul><li>删除文本节点</li></ul></li><li>新：文本 <ul><li>更新文本节点</li></ul></li><li>新：数组 <ul><li>删除文本节点</li><li>挂载数组节点</li></ul></li></ul></li><li><strong>旧：数组</strong><ul><li>新：空 <ul><li>删除数组节点</li></ul></li><li>新：文本 <ul><li>删除数组所有节点</li><li>挂载文本节点</li></ul></li><li><strong>新：数组</strong></li></ul></li></ul><p>其中最为复杂情况就是如果新旧 vnode 的 children 都是 vnode 数组，为了尽可能提高 diff 效率、节点复用，vue3 采用了去头尾的最长递增子序列算法。</p><h3 id="vue-去头尾的最长递增子序列算法" tabindex="-1"><a class="header-anchor" href="#vue-去头尾的最长递增子序列算法" aria-hidden="true">#</a> vue 去头尾的最长递增子序列算法</h3><ol><li>先对齐的前置元素和后置元素</li><li>对齐后存在三种情况 <ol><li>只有新子序列中有剩余要添加的新节点 <img src="/assets/img/58671c556dfbbe383fb40d5cbde60526b1c696a727506c8b011b8c27d77b1891.60695ba5.png" alt="图 7"></li><li>只有旧子序列中有剩余要删除的新节点 <img src="/assets/img/061fc7cc5bbfbda4db890940db416c0321e5aea40ae9a06d68c0bf54887dad08.5fa9d414.png" alt="图 8"></li><li>双方都存在未知子序列 <img src="/assets/img/1fcbe5f39d6f1879588feba75d76f01ef5b64bedeaa807eac9ca97cea3909daa.cce26a2f.png" alt="图 7"></li></ol></li></ol><h4 id="最长递增子序列" tabindex="-1"><a class="header-anchor" href="#最长递增子序列" aria-hidden="true">#</a> 最长递增子序列</h4><div class="language-text ext-text"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#24292f;">prev [1, 2, 3, 4, 5, 6]</span></span>
<span class="line"><span style="color:#24292f;">next [1, 3, 2, 6, 4, 5]</span></span>
<span class="line"><span style="color:#24292f;"></span></span></code></pre></div><p>从 prev 变成 next，数组里的一些元素的顺序发生了变化，如何用最少的移动使元素顺序从 prev 变化为 next。</p><p>一种思路是在 next 中找到一个递增子序列，比如 [1, 3, 6] 、[1, 2, 4, 5]。之后对 next 数组进行倒序遍历，移动所有不在递增序列中的元素即可。</p><p>如果选择了 [1, 3, 6] 作为递增子序列，那么要移动三次，如果选择了 [1, 2, 4, 5] 作为递增子序列，遇到 5、4、2、1 不动，遇到 6、3 移动即可，也就只需要移动两次，故只要找最长递增子序列。</p><p><a href="https://leetcode-cn.com/problems/longest-increasing-subsequence/" target="_blank" rel="noopener noreferrer">最长递增子序列算法传送门<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</p><h3 id="源码分析" tabindex="-1"><a class="header-anchor" href="#源码分析" aria-hidden="true">#</a> 源码分析</h3><blockquote><p>以下笔者仅仅只是注释代码，可结合上面例子理解。</p></blockquote><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// packages/runtime-core/src/renderer.ts</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// can be all-keyed or mixed</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">patchKeyedChildren</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">c1</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;">[],</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">c2</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNodeArrayChildren</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">container</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">RendererElement</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">parentAnchor</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">RendererNode</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">parentComponent</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">ComponentInternalInstance</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">parentSuspense</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">SuspenseBoundary</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">isSVG</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">boolean</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">slotScopeIds</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">string</span><span style="color:#24292F;">[] </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">optimized</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">boolean</span></span>
<span class="line"><span style="color:#24292F;">  ) </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">let</span><span style="color:#24292F;"> i </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">0</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">l2</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> c2.</span><span style="color:#0550AE;">length</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">let</span><span style="color:#24292F;"> e1 </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> c1.</span><span style="color:#0550AE;">length</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">-</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">1</span><span style="color:#24292F;"> </span><span style="color:#6E7781;">// 旧序列尾部索引</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">let</span><span style="color:#24292F;"> e2 </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> l2 </span><span style="color:#CF222E;">-</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">1</span><span style="color:#24292F;"> </span><span style="color:#6E7781;">// 新序列尾部索引</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 头部对齐</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 如果类型不同或者索引 i 大于索引 e1 或者 e2，则同步过程结束。</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 1. sync from start</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// (a b) c</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// (a b) d e</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">while</span><span style="color:#24292F;"> (i </span><span style="color:#CF222E;">&lt;=</span><span style="color:#24292F;"> e1 </span><span style="color:#CF222E;">&amp;&amp;</span><span style="color:#24292F;"> i </span><span style="color:#CF222E;">&lt;=</span><span style="color:#24292F;"> e2) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">n1</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> c1[i]</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">n2</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (c2[i] </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> optimized</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">?</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">cloneIfMounted</span><span style="color:#24292F;">(c2[i] </span><span style="color:#CF222E;">as</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;">)</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">normalizeVNode</span><span style="color:#24292F;">(c2[i]))</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (</span><span style="color:#8250DF;">isSameVNodeType</span><span style="color:#24292F;">(n1, n2)) {</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#8250DF;">patch</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">          n1,</span></span>
<span class="line"><span style="color:#24292F;">          n2,</span></span>
<span class="line"><span style="color:#24292F;">          container,</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">          parentComponent,</span></span>
<span class="line"><span style="color:#24292F;">          parentSuspense,</span></span>
<span class="line"><span style="color:#24292F;">          isSVG,</span></span>
<span class="line"><span style="color:#24292F;">          slotScopeIds,</span></span>
<span class="line"><span style="color:#24292F;">          optimized</span></span>
<span class="line"><span style="color:#24292F;">        )</span></span>
<span class="line"><span style="color:#24292F;">      } </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">break</span></span>
<span class="line"><span style="color:#24292F;">      }</span></span>
<span class="line"><span style="color:#24292F;">      i</span><span style="color:#CF222E;">++</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 头部对齐结束，此时 i 为不同类型节点的下标 </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 尾部对齐</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// e1、e2 循环递减</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 如果不同或者索引 i 大于索引 e1 或者 e2，则同步过程结束。</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 2. sync from end</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// a (b c)</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// d e (b c)</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">while</span><span style="color:#24292F;"> (i </span><span style="color:#CF222E;">&lt;=</span><span style="color:#24292F;"> e1 </span><span style="color:#CF222E;">&amp;&amp;</span><span style="color:#24292F;"> i </span><span style="color:#CF222E;">&lt;=</span><span style="color:#24292F;"> e2) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">n1</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> c1[e1]</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">n2</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (c2[e2] </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> optimized</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">?</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">cloneIfMounted</span><span style="color:#24292F;">(c2[e2] </span><span style="color:#CF222E;">as</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;">)</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">normalizeVNode</span><span style="color:#24292F;">(c2[e2]))</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (</span><span style="color:#8250DF;">isSameVNodeType</span><span style="color:#24292F;">(n1, n2)) {</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#8250DF;">patch</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">          n1,</span></span>
<span class="line"><span style="color:#24292F;">          n2,</span></span>
<span class="line"><span style="color:#24292F;">          container,</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">          parentComponent,</span></span>
<span class="line"><span style="color:#24292F;">          parentSuspense,</span></span>
<span class="line"><span style="color:#24292F;">          isSVG,</span></span>
<span class="line"><span style="color:#24292F;">          slotScopeIds,</span></span>
<span class="line"><span style="color:#24292F;">          optimized</span></span>
<span class="line"><span style="color:#24292F;">        )</span></span>
<span class="line"><span style="color:#24292F;">      } </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">break</span></span>
<span class="line"><span style="color:#24292F;">      }</span></span>
<span class="line"><span style="color:#24292F;">      e1</span><span style="color:#CF222E;">--</span></span>
<span class="line"><span style="color:#24292F;">      e2</span><span style="color:#CF222E;">--</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// i &gt; e1，i &lt;= e2 说明旧序列已经闭合（全部对齐更新完成），只剩新序列存在新节点</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 新增新节点</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 3. common sequence + mount</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// (a b)</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// (a b) c</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// i = 2, e1 = 1, e2 = 2</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// (a b)</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// c (a b)</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// i = 0, e1 = -1, e2 = 0</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (i </span><span style="color:#CF222E;">&gt;</span><span style="color:#24292F;"> e1) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (i </span><span style="color:#CF222E;">&lt;=</span><span style="color:#24292F;"> e2) {</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">nextPos</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> e2 </span><span style="color:#CF222E;">+</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">1</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">anchor</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> nextPos </span><span style="color:#CF222E;">&lt;</span><span style="color:#24292F;"> l2 </span><span style="color:#CF222E;">?</span><span style="color:#24292F;"> (c2[nextPos] </span><span style="color:#CF222E;">as</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;">).el </span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> parentAnchor</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">while</span><span style="color:#24292F;"> (i </span><span style="color:#CF222E;">&lt;=</span><span style="color:#24292F;"> e2) {</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#8250DF;">patch</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">            </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">            (c2[i] </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> optimized</span></span>
<span class="line"><span style="color:#24292F;">              </span><span style="color:#CF222E;">?</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">cloneIfMounted</span><span style="color:#24292F;">(c2[i] </span><span style="color:#CF222E;">as</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;">)</span></span>
<span class="line"><span style="color:#24292F;">              </span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">normalizeVNode</span><span style="color:#24292F;">(c2[i])),</span></span>
<span class="line"><span style="color:#24292F;">            container,</span></span>
<span class="line"><span style="color:#24292F;">            anchor,</span></span>
<span class="line"><span style="color:#24292F;">            parentComponent,</span></span>
<span class="line"><span style="color:#24292F;">            parentSuspense,</span></span>
<span class="line"><span style="color:#24292F;">            isSVG,</span></span>
<span class="line"><span style="color:#24292F;">            slotScopeIds,</span></span>
<span class="line"><span style="color:#24292F;">            optimized</span></span>
<span class="line"><span style="color:#24292F;">          )</span></span>
<span class="line"><span style="color:#24292F;">          i</span><span style="color:#CF222E;">++</span></span>
<span class="line"><span style="color:#24292F;">        }</span></span>
<span class="line"><span style="color:#24292F;">      }</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// i &gt; e2，i &lt;= e1 说明新序列已经闭合（全部对齐更新完成），只剩旧序列存在旧节点</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 删除旧节点</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 4. common sequence + unmount</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// (a b) c</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// (a b)</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// i = 2, e1 = 2, e2 = 1</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// a (b c)</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// (b c)</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// i = 0, e1 = 0, e2 = -1</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (i </span><span style="color:#CF222E;">&gt;</span><span style="color:#24292F;"> e2) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">while</span><span style="color:#24292F;"> (i </span><span style="color:#CF222E;">&lt;=</span><span style="color:#24292F;"> e1) {</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#8250DF;">unmount</span><span style="color:#24292F;">(c1[i], parentComponent, parentSuspense, </span><span style="color:#0550AE;">true</span><span style="color:#24292F;">)</span></span>
<span class="line"><span style="color:#24292F;">        i</span><span style="color:#CF222E;">++</span></span>
<span class="line"><span style="color:#24292F;">      }</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 5. unknown sequence</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 新旧序列存在未知子序列</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// [i ... e1 + 1]: a b [c d e] f g</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// [i ... e2 + 1]: a b [e d c h] f g</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// i = 2, e1 = 4, e2 = 5</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">s1</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> i </span><span style="color:#6E7781;">// prev starting index</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">s2</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> i </span><span style="color:#6E7781;">// next starting index</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// 5.1 build key:index map for newChildren</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// 建立新序列节点索引，方便遍历旧序列式，直接查找新序列，时间换空间</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">keyToNewIndexMap</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">Map</span><span style="color:#24292F;">&lt;</span><span style="color:#0550AE;">string</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">number</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">symbol</span><span style="color:#24292F;">, </span><span style="color:#0550AE;">number</span><span style="color:#24292F;">&gt; </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">new</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">Map</span><span style="color:#24292F;">()</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">for</span><span style="color:#24292F;"> (i </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> s2; i </span><span style="color:#CF222E;">&lt;=</span><span style="color:#24292F;"> e2; i</span><span style="color:#CF222E;">++</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">nextChild</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (c2[i] </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> optimized</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#CF222E;">?</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">cloneIfMounted</span><span style="color:#24292F;">(c2[i] </span><span style="color:#CF222E;">as</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;">)</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">normalizeVNode</span><span style="color:#24292F;">(c2[i]))</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (nextChild.key </span><span style="color:#CF222E;">!=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (__DEV__ </span><span style="color:#CF222E;">&amp;&amp;</span><span style="color:#24292F;"> keyToNewIndexMap.</span><span style="color:#8250DF;">has</span><span style="color:#24292F;">(nextChild.key)) {</span></span>
<span class="line"><span style="color:#24292F;">            </span><span style="color:#8250DF;">warn</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">              </span><span style="color:#0A3069;">`Duplicate keys found during update:`</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">              </span><span style="color:#0550AE;">JSON</span><span style="color:#24292F;">.</span><span style="color:#0550AE;">stringify</span><span style="color:#24292F;">(nextChild.key),</span></span>
<span class="line"><span style="color:#24292F;">              </span><span style="color:#0A3069;">`Make sure keys are unique.`</span></span>
<span class="line"><span style="color:#24292F;">            )</span></span>
<span class="line"><span style="color:#24292F;">          }</span></span>
<span class="line"><span style="color:#24292F;">          keyToNewIndexMap.</span><span style="color:#8250DF;">set</span><span style="color:#24292F;">(nextChild.key, i)</span></span>
<span class="line"><span style="color:#24292F;">        }</span></span>
<span class="line"><span style="color:#24292F;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// 5.2 loop through old children left to be patched and try to patch</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// matching nodes &amp; remove nodes that are no longer present</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// 遍历旧序列，删除不存在新序列的节点</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">let</span><span style="color:#24292F;"> j</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">let</span><span style="color:#24292F;"> patched </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">0</span><span style="color:#24292F;"> </span><span style="color:#6E7781;">// 已经处理节点的数量</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">toBePatched</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> e2 </span><span style="color:#CF222E;">-</span><span style="color:#24292F;"> s2 </span><span style="color:#CF222E;">+</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">1</span><span style="color:#24292F;"> </span><span style="color:#6E7781;">// 待处理节点的数量</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">let</span><span style="color:#24292F;"> moved </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">false</span><span style="color:#24292F;"> </span><span style="color:#6E7781;">// 标记节点序列是否移动</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// used to track whether any node has moved</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">let</span><span style="color:#24292F;"> maxNewIndexSoFar </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">0</span><span style="color:#24292F;"> </span><span style="color:#6E7781;">// 始终存储的是上次求值的 newIndex</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// works as Map&lt;newIndex, oldIndex&gt;</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// Note that oldIndex is offset by +1</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// and oldIndex = 0 is a special value indicating the new node has</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// no corresponding old node.</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// used for determining longest stable subsequence</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// 存储新子序列中的元素在原旧子序列节点的索引，用于确定最长递增子序列</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// 0 是特殊🈯️，表示新增节点，故节点索引 + 1</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">newIndexToOldIndexMap</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">new</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">Array</span><span style="color:#24292F;">(toBePatched)</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">for</span><span style="color:#24292F;"> (i </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">0</span><span style="color:#24292F;">; i </span><span style="color:#CF222E;">&lt;</span><span style="color:#24292F;"> toBePatched; i</span><span style="color:#CF222E;">++</span><span style="color:#24292F;">) newIndexToOldIndexMap[i] </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// 遍历旧序列，进行删除和更新</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">for</span><span style="color:#24292F;"> (i </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> s1; i </span><span style="color:#CF222E;">&lt;=</span><span style="color:#24292F;"> e1; i</span><span style="color:#CF222E;">++</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">prevChild</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> c1[i]</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#6E7781;">// 所有新的节点都已经被处理完了，那么剩余的旧节点则统统删除</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (patched </span><span style="color:#CF222E;">&gt;=</span><span style="color:#24292F;"> toBePatched) {</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#6E7781;">// all new children have been patched so this can only be a removal</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#8250DF;">unmount</span><span style="color:#24292F;">(prevChild, parentComponent, parentSuspense, </span><span style="color:#0550AE;">true</span><span style="color:#24292F;">)</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#CF222E;">continue</span></span>
<span class="line"><span style="color:#24292F;">        }</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">let</span><span style="color:#24292F;"> newIndex </span><span style="color:#6E7781;">// 记录节点在新序列中的位置</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (prevChild.key </span><span style="color:#CF222E;">!=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">          newIndex </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> keyToNewIndexMap.</span><span style="color:#8250DF;">get</span><span style="color:#24292F;">(prevChild.key)</span></span>
<span class="line"><span style="color:#24292F;">        } </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#6E7781;">// key-less node, try to locate a key-less node of the same type</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#CF222E;">for</span><span style="color:#24292F;"> (j </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> s2; j </span><span style="color:#CF222E;">&lt;=</span><span style="color:#24292F;"> e2; j</span><span style="color:#CF222E;">++</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">            </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (</span></span>
<span class="line"><span style="color:#24292F;">              newIndexToOldIndexMap[j </span><span style="color:#CF222E;">-</span><span style="color:#24292F;"> s2] </span><span style="color:#CF222E;">===</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">0</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292F;">              </span><span style="color:#8250DF;">isSameVNodeType</span><span style="color:#24292F;">(prevChild, c2[j] </span><span style="color:#CF222E;">as</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;">)</span></span>
<span class="line"><span style="color:#24292F;">            ) {</span></span>
<span class="line"><span style="color:#24292F;">              newIndex </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> j</span></span>
<span class="line"><span style="color:#24292F;">              </span><span style="color:#CF222E;">break</span></span>
<span class="line"><span style="color:#24292F;">            }</span></span>
<span class="line"><span style="color:#24292F;">          }</span></span>
<span class="line"><span style="color:#24292F;">        }</span></span>
<span class="line"><span style="color:#24292F;">        </span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (newIndex </span><span style="color:#CF222E;">===</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">undefined</span><span style="color:#24292F;">) { </span><span style="color:#6E7781;">// 旧节点不存在新序列，直接删除</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#8250DF;">unmount</span><span style="color:#24292F;">(prevChild, parentComponent, parentSuspense, </span><span style="color:#0550AE;">true</span><span style="color:#24292F;">)</span></span>
<span class="line"><span style="color:#24292F;">        } </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> { </span><span style="color:#6E7781;">// 更新旧节点</span></span>
<span class="line"><span style="color:#24292F;">          newIndexToOldIndexMap[newIndex </span><span style="color:#CF222E;">-</span><span style="color:#24292F;"> s2] </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> i </span><span style="color:#CF222E;">+</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">1</span><span style="color:#24292F;"> </span><span style="color:#6E7781;">// 0 表示新增，故需要 + 1 ，避开占位到 0</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#6E7781;">/**</span></span>
<span class="line"><span style="color:#6E7781;">          * 用变量 maxNewIndexSoFar 跟踪判断节点是否移动，maxNewIndexSoFar 始终存储的是上次求值的 newIndex，</span></span>
<span class="line"><span style="color:#6E7781;">          * 一旦本次求值的 newIndex 小于 maxNewIndexSoFar，这说明顺序遍历旧子序列的节点在新子序列中的索引并不是一直递增的，</span></span>
<span class="line"><span style="color:#6E7781;">          * 也就说明存在移动的情况。</span></span>
<span class="line"><span style="color:#6E7781;">          */</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (newIndex </span><span style="color:#CF222E;">&gt;=</span><span style="color:#24292F;"> maxNewIndexSoFar) {</span></span>
<span class="line"><span style="color:#24292F;">            maxNewIndexSoFar </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> newIndex</span></span>
<span class="line"><span style="color:#24292F;">          } </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">            moved </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">true</span></span>
<span class="line"><span style="color:#24292F;">          }</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#8250DF;">patch</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">            prevChild,</span></span>
<span class="line"><span style="color:#24292F;">            c2[newIndex] </span><span style="color:#CF222E;">as</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">            container,</span></span>
<span class="line"><span style="color:#24292F;">            </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">            parentComponent,</span></span>
<span class="line"><span style="color:#24292F;">            parentSuspense,</span></span>
<span class="line"><span style="color:#24292F;">            isSVG,</span></span>
<span class="line"><span style="color:#24292F;">            slotScopeIds,</span></span>
<span class="line"><span style="color:#24292F;">            optimized</span></span>
<span class="line"><span style="color:#24292F;">          )</span></span>
<span class="line"><span style="color:#24292F;">          patched</span><span style="color:#CF222E;">++</span></span>
<span class="line"><span style="color:#24292F;">        }</span></span>
<span class="line"><span style="color:#24292F;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// 前面删除更新旧节点，接下来需要对旧节点移动调整位置和新增新节点</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// 5.3 move and mount</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// generate longest stable subsequence only when nodes have moved</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// 序列发生移动，生成最长递增子序列，计算出最少移动元素</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">increasingNewIndexSequence</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> moved</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">?</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">getSequence</span><span style="color:#24292F;">(newIndexToOldIndexMap)</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">EMPTY_ARR</span></span>
<span class="line"><span style="color:#24292F;">      j </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> increasingNewIndexSequence.</span><span style="color:#0550AE;">length</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">-</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">1</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// looping backwards so that we can use last patched node as anchor</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// 倒序遍历新序列</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// 为什么倒序，DOM 平台上对插入和移动都是使用 node.insertBefore</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// node.insertBefore 对节点的移动都得使用 anchor</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// 使用倒序，保证了前面的节点是最新处理过的</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">for</span><span style="color:#24292F;"> (i </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> toBePatched </span><span style="color:#CF222E;">-</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">1</span><span style="color:#24292F;">; i </span><span style="color:#CF222E;">&gt;=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">0</span><span style="color:#24292F;">; i</span><span style="color:#CF222E;">--</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">nextIndex</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> s2 </span><span style="color:#CF222E;">+</span><span style="color:#24292F;"> i</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">nextChild</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> c2[nextIndex] </span><span style="color:#CF222E;">as</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">anchor</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span></span>
<span class="line"><span style="color:#24292F;">          nextIndex </span><span style="color:#CF222E;">+</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">1</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">&lt;</span><span style="color:#24292F;"> l2 </span><span style="color:#CF222E;">?</span><span style="color:#24292F;"> (c2[nextIndex </span><span style="color:#CF222E;">+</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">1</span><span style="color:#24292F;">] </span><span style="color:#CF222E;">as</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;">).el </span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> parentAnchor</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (newIndexToOldIndexMap[i] </span><span style="color:#CF222E;">===</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">0</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#6E7781;">// mount new</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#8250DF;">patch</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">            </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">            nextChild,</span></span>
<span class="line"><span style="color:#24292F;">            container,</span></span>
<span class="line"><span style="color:#24292F;">            anchor,</span></span>
<span class="line"><span style="color:#24292F;">            parentComponent,</span></span>
<span class="line"><span style="color:#24292F;">            parentSuspense,</span></span>
<span class="line"><span style="color:#24292F;">            isSVG,</span></span>
<span class="line"><span style="color:#24292F;">            slotScopeIds,</span></span>
<span class="line"><span style="color:#24292F;">            optimized</span></span>
<span class="line"><span style="color:#24292F;">          )</span></span>
<span class="line"><span style="color:#24292F;">        } </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (moved) {</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#6E7781;">// move if:</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#6E7781;">// There is no stable subsequence (e.g. a reverse)</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#6E7781;">// OR current node is not among the stable sequence</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#6E7781;">// 跳过在递增子序列里的元素</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (j </span><span style="color:#CF222E;">&lt;</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">0</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">||</span><span style="color:#24292F;"> i </span><span style="color:#CF222E;">!==</span><span style="color:#24292F;"> increasingNewIndexSequence[j]) {</span></span>
<span class="line"><span style="color:#24292F;">            </span><span style="color:#8250DF;">move</span><span style="color:#24292F;">(nextChild, container, anchor, MoveType.</span><span style="color:#0550AE;">REORDER</span><span style="color:#24292F;">)</span></span>
<span class="line"><span style="color:#24292F;">          } </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">            j</span><span style="color:#CF222E;">--</span></span>
<span class="line"><span style="color:#24292F;">          }</span></span>
<span class="line"><span style="color:#24292F;">        }</span></span>
<span class="line"><span style="color:#24292F;">      }</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"></span></code></pre></div><h2 id="why-key" tabindex="-1"><a class="header-anchor" href="#why-key" aria-hidden="true">#</a> Why key</h2><blockquote><p>在 diff 新旧序列中，使用 key 能够帮助我们建立索引，更快的找到可复用的 VNode，节省性能开销。使用 index 作为 key 有可能造成 VNode 错误的复用，从而产生 bug ，而使用 random 作为 key 会导致VNode 始终无法复用，极大的影响性能。</p><p>更多详情、例子可阅读 <a href="https://juejin.cn/post/6999932053466644517#comment" target="_blank" rel="noopener noreferrer">《我用index作为key也没啥问题啊》<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><h2 id="不带-key" tabindex="-1"><a class="header-anchor" href="#不带-key" aria-hidden="true">#</a> 不带 key</h2><p>不带 key 的情况下，vue diff 子节点是直接按顺序对比，多余的节点就删除或者新增。 如果子节点类型不同，就直接删除新增，造成更频繁的 DOM 操作。</p><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">patchUnkeyedChildren</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">c1</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;">[],</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">c2</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNodeArrayChildren</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">container</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">RendererElement</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">anchor</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">RendererNode</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">parentComponent</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">ComponentInternalInstance</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">parentSuspense</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">SuspenseBoundary</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">isSVG</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">boolean</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">slotScopeIds</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">string</span><span style="color:#24292F;">[] </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">optimized</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">boolean</span></span>
<span class="line"><span style="color:#24292F;">  ) </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">    c1 </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> c1 </span><span style="color:#CF222E;">||</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">EMPTY_ARR</span></span>
<span class="line"><span style="color:#24292F;">    c2 </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> c2 </span><span style="color:#CF222E;">||</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">EMPTY_ARR</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">oldLength</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> c1.</span><span style="color:#0550AE;">length</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">newLength</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> c2.</span><span style="color:#0550AE;">length</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">commonLength</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">Math</span><span style="color:#24292F;">.</span><span style="color:#0550AE;">min</span><span style="color:#24292F;">(oldLength, newLength)</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">let</span><span style="color:#24292F;"> i</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 对比公共长度的子序列</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">for</span><span style="color:#24292F;"> (i </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">0</span><span style="color:#24292F;">; i </span><span style="color:#CF222E;">&lt;</span><span style="color:#24292F;"> commonLength; i</span><span style="color:#CF222E;">++</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">nextChild</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (c2[i] </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> optimized</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">?</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">cloneIfMounted</span><span style="color:#24292F;">(c2[i] </span><span style="color:#CF222E;">as</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;">)</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">normalizeVNode</span><span style="color:#24292F;">(c2[i]))</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#8250DF;">patch</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">        c1[i],</span></span>
<span class="line"><span style="color:#24292F;">        nextChild,</span></span>
<span class="line"><span style="color:#24292F;">        container,</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">        parentComponent,</span></span>
<span class="line"><span style="color:#24292F;">        parentSuspense,</span></span>
<span class="line"><span style="color:#24292F;">        isSVG,</span></span>
<span class="line"><span style="color:#24292F;">        slotScopeIds,</span></span>
<span class="line"><span style="color:#24292F;">        optimized</span></span>
<span class="line"><span style="color:#24292F;">      )</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// 删除多余节点</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (oldLength </span><span style="color:#CF222E;">&gt;</span><span style="color:#24292F;"> newLength) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// remove old</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#8250DF;">unmountChildren</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">        c1,</span></span>
<span class="line"><span style="color:#24292F;">        parentComponent,</span></span>
<span class="line"><span style="color:#24292F;">        parentSuspense,</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#0550AE;">true</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#0550AE;">false</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">        commonLength</span></span>
<span class="line"><span style="color:#24292F;">      )</span></span>
<span class="line"><span style="color:#24292F;">    } </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> { </span><span style="color:#6E7781;">// 新增多余节点</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// mount new</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#8250DF;">mountChildren</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">        c2,</span></span>
<span class="line"><span style="color:#24292F;">        container,</span></span>
<span class="line"><span style="color:#24292F;">        anchor,</span></span>
<span class="line"><span style="color:#24292F;">        parentComponent,</span></span>
<span class="line"><span style="color:#24292F;">        parentSuspense,</span></span>
<span class="line"><span style="color:#24292F;">        isSVG,</span></span>
<span class="line"><span style="color:#24292F;">        slotScopeIds,</span></span>
<span class="line"><span style="color:#24292F;">        optimized,</span></span>
<span class="line"><span style="color:#24292F;">        commonLength</span></span>
<span class="line"><span style="color:#24292F;">      )</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"></span></code></pre></div><h2 id="编译优化" tabindex="-1"><a class="header-anchor" href="#编译优化" aria-hidden="true">#</a> 编译优化</h2><p>Vue3 diff 算法的主要优势是结合<strong>编译优化</strong>，在编译阶段对静态模板分析，生成 Block tree，收集动态更新的节点，然后在 patch 阶段就可以只比对 Block tree 中的节点，达到提升 diff 性能的目的。而核心 diff 算法，也就是<strong>去头尾的最长递增子序列算法</strong>和 vue2 <strong>双端比较算法</strong>就性能而言差别并不大。详见 <a href="/Vue/vue%20%E7%BC%96%E8%AF%91%E4%BC%98%E5%8C%96.html" class="">vue 编译优化</a>。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><ol><li>vue 的渲染更新都是以组件为单位的</li><li>一个组件发生更新有两种情况：state、props 发生变更</li><li>diff 更新流程：整个更新过程树的深度递归 diff，先对比父节点，然后对子节点进行同层对比，其中子节点数组的更新又分为多种情况，其中最复杂的情况为数组到数组的更新，使用<strong>去头尾的最长递增子序列</strong>算法，再对每个子节点深度递归 diff。</li></ol><p><img src="/assets/img/089ea60df2fe1490c5fb0c69e460a9681c509346e0486d52a95d131902cbbc92.7d6fc3a3.png" alt="图 6"></p><h2 id="参考" tabindex="-1"><a class="header-anchor" href="#参考" aria-hidden="true">#</a> 参考</h2><ul><li><a href="https://github.com/ascoders/weekly/blob/master/%E5%89%8D%E6%B2%BF%E6%8A%80%E6%9C%AF/190.%E7%B2%BE%E8%AF%BB%E3%80%8ADOM20%25diff20%25%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3%E3%80%8B.md" target="_blank" rel="noopener noreferrer">190.精读《DOM diff 原理详解》<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li>Vue.js 3.0 核心源码解析</li><li><a href="https://github.com/NervJS/nerv/issues/3" target="_blank" rel="noopener noreferrer">diff 算法原理概述<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul></div><!----></article></div><footer class="footer footer-center p-4 bg-base-300 text-base-content opacity-60"><div><p>©2017-2021 laoergege.cn. All right reserved. </p><p><a href="https://beian.miit.gov.cn" target="_blank" class="link link-hover">粤ICP备2022020679号</a></p></div></footer><!--]--><!----><!--]--></div>
    <script src="/assets/js/runtime~app.7d4bd660.js" defer></script><script src="/assets/js/5838.13a569e5.js" defer></script><script src="/assets/js/app.7e792774.js" defer></script>
</body>

</html>