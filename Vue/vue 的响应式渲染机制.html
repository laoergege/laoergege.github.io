<!DOCTYPE html>
<html lang="zh-CN" data-theme="cupcake">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.46">
    <link rel="manifest" href="/site.webmanifest.json"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><title>Vue çš„å“åº”å¼æ¸²æŸ“æœºåˆ¶ | </title><meta name="description" content="Just For Fun">
    <link rel="preload" href="/assets/js/runtime~app.7d4bd660.js" as="script"><link rel="preload" href="/assets/css/styles.1c65b737.css" as="style"><link rel="preload" href="/assets/js/5838.13a569e5.js" as="script"><link rel="preload" href="/assets/js/app.7e792774.js" as="script"><link rel="prefetch" href="/assets/js/v-03fc2322.47d94022.js"><link rel="prefetch" href="/assets/js/v-ba2c1988.3632b5e0.js"><link rel="prefetch" href="/assets/js/v-fd8e5af2.a9cafb88.js"><link rel="prefetch" href="/assets/js/v-5a071f34.190f1fdc.js"><link rel="prefetch" href="/assets/js/v-317472f1.a3c9dba2.js"><link rel="prefetch" href="/assets/js/v-560b844b.09f8a065.js"><link rel="prefetch" href="/assets/js/v-85bc3e4c.27575d9e.js"><link rel="prefetch" href="/assets/js/v-4835f72d.209f9a9b.js"><link rel="prefetch" href="/assets/js/v-6f2abf9c.c6a52b82.js"><link rel="prefetch" href="/assets/js/v-32c68258.46247de2.js"><link rel="prefetch" href="/assets/js/v-04983e79.ae40370a.js"><link rel="prefetch" href="/assets/js/v-7269d92e.00653b56.js"><link rel="prefetch" href="/assets/js/v-54e51afe.e3f20358.js"><link rel="prefetch" href="/assets/js/v-5fbdabee.afcc17b5.js"><link rel="prefetch" href="/assets/js/v-928f5a14.0a4a3dc4.js"><link rel="prefetch" href="/assets/js/v-88c7f226.529f6212.js"><link rel="prefetch" href="/assets/js/v-5e99732b.68dd2407.js"><link rel="prefetch" href="/assets/js/v-2fc78b4d.97b37f50.js"><link rel="prefetch" href="/assets/js/v-d99bba28.2cf82742.js"><link rel="prefetch" href="/assets/js/v-bee2f4a8.f072eb83.js"><link rel="prefetch" href="/assets/js/v-57ad8616.44af159f.js"><link rel="prefetch" href="/assets/js/v-f701b528.aa7f8f17.js"><link rel="prefetch" href="/assets/js/v-093d016d.bc725dd1.js"><link rel="prefetch" href="/assets/js/v-06ed95cc.0db5595a.js"><link rel="prefetch" href="/assets/js/v-01b20944.db789013.js"><link rel="prefetch" href="/assets/js/v-137d7552.50039c10.js"><link rel="prefetch" href="/assets/css/5045.styles.72ac531f.css"><link rel="prefetch" href="/assets/js/v-631fc68a.80740d81.js"><link rel="prefetch" href="/assets/js/v-8b5f7690.191ba9a3.js"><link rel="prefetch" href="/assets/js/v-530f22f6.f8e361fa.js"><link rel="prefetch" href="/assets/js/v-be2646cc.549f65bf.js"><link rel="prefetch" href="/assets/js/v-75e44f07.2f8601c3.js"><link rel="prefetch" href="/assets/js/v-c2504efe.28c55f92.js"><link rel="prefetch" href="/assets/js/v-5bc51cd9.b23c2caa.js"><link rel="prefetch" href="/assets/js/5956.f176ea33.js"><link rel="prefetch" href="/assets/js/v-6dc8e518.a8181c32.js"><link rel="prefetch" href="/assets/js/v-568d3b89.483d19f1.js"><link rel="prefetch" href="/assets/js/v-743faa02.3247db36.js"><link rel="prefetch" href="/assets/js/v-d52c6cc0.34d4b256.js"><link rel="prefetch" href="/assets/js/v-78263bfa.b7cb21e4.js"><link rel="prefetch" href="/assets/js/v-199de1f8.16ad6f91.js"><link rel="prefetch" href="/assets/js/v-30078430.3079f1d2.js"><link rel="prefetch" href="/assets/js/v-240dbb06.02e786fb.js"><link rel="prefetch" href="/assets/js/v-7a102f72.94a1b7e7.js"><link rel="prefetch" href="/assets/js/v-1402111c.9dc8cc11.js"><link rel="prefetch" href="/assets/js/v-f2bbc8da.fc4d9aa5.js"><link rel="prefetch" href="/assets/js/v-b0176dc2.b994ff0c.js"><link rel="prefetch" href="/assets/js/4644.1787b6ff.js"><link rel="prefetch" href="/assets/js/v-a5da5a08.cc633de8.js"><link rel="prefetch" href="/assets/js/v-acadbc84.800a32fa.js"><link rel="prefetch" href="/assets/js/v-a270a8ca.ea9c331c.js"><link rel="prefetch" href="/assets/js/v-a9440b46.63ee3544.js"><link rel="prefetch" href="/assets/js/6929.46233b49.js"><link rel="prefetch" href="/assets/js/9840.789f773b.js"><link rel="prefetch" href="/assets/js/v-9f06f78c.ff18832e.js"><link rel="prefetch" href="/assets/js/9870.c84a31ac.js"><link rel="prefetch" href="/assets/js/v-8daa1a0e.8245b191.js"><link rel="prefetch" href="/sw.js"><link rel="prefetch" href="/assets/css/3859.styles.7057c730.css">
    <link rel="stylesheet" href="/assets/css/styles.1c65b737.css">
</head>

<body>
    <div id="app"><!--[--><!--[--><div class="navbar sticky top-0 z-10"><a href="/" class=""><label class="btn btn-circle avatar"><div class="rounded-full ring ring-white shadow-2xl no-zoom"><img src="/avatar.webp"></div></label></a></div><div class="min-h-screen flex justify-center flex-col items-center"><article class="article w-full sm:w-3/4 lg:w-2/3 p-4" data-theme="cupcake"><div class="sm:max-w-full pb-12 prose sm:prose-sm md:prose-lg dark:prose-invert"><h1 id="vue-çš„å“åº”å¼æ¸²æŸ“æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#vue-çš„å“åº”å¼æ¸²æŸ“æœºåˆ¶" aria-hidden="true">#</a> Vue çš„å“åº”å¼æ¸²æŸ“æœºåˆ¶</h1><blockquote><p>ä»¥ä¸‹ä»£ç ç¤ºä¾‹ç‰ˆæœ¬ vue3.2</p></blockquote><p>Vue çš„å“åº”å¼æ¸²æŸ“æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯ MDVï¼ˆModel-Driven-Viewï¼‰æ•°æ®é©±åŠ¨è§†å›¾çš„å®ç°åŸç†ã€‚åœ¨ MDV çš„ç†å¿µä¸‹ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨ä¸šåŠ¡æ•°æ®å˜åŒ–ï¼Œè‡³äºçŠ¶æ€å˜åŒ–å¦‚ä½•è‡ªåŠ¨åŒ–åŒæ­¥æ˜ å°„æˆ UI å°±äº¤ç»™è§†å›¾å±‚æ¡†æ¶è§£å†³ã€‚</p><p>åœ¨ vue çš„å“åº”å¼ç³»ç»Ÿé‡Œï¼Œæ•°æ®å³å“åº”å¼æ•°æ®ï¼Œè€Œè§†å›¾æ¸²æŸ“åˆ™æ˜¯ä¸€ç§å‰¯ä½œç”¨ã€‚</p><p><img src="/assets/img/e42d0897f1ae88b0b163646ca8b25880307282361ccb232159ade5ed8b796d52.3c22ac58.png" alt="å›¾ 11"></p><p>vue å“åº”å¼æ›´æ–°æ¸²æŸ“æœºåˆ¶:</p><p><img src="/assets/img/2aa3f18582022b697f8312ccbbb6a029a91e761ccdaa4f8e3cdabf3bc8896862.0e581755.png" alt="å›¾ 2"></p><p>vue3 çš„å“åº”å¼æ¸²æŸ“æœºåˆ¶è·Ÿ vue2 å…¶å®åŒºåˆ«ä¸å¤§ï¼Œå…¶ä¸­ï¼š</p><ol><li>ç»„ä»¶æ¸²æŸ“å˜æˆæˆå‰¯ä½œç”¨</li><li>æ¸²æŸ“å‰¯ä½œç”¨æ‰§è¡Œè¿‡ç¨‹è§¦å‘æ•°æ®ä¾èµ–æ”¶é›†</li><li>æ•°æ®å˜åŒ–è§¦å‘æ›´æ–°ä»»åŠ¡è¿›å…¥å¼‚æ­¥é˜Ÿåˆ—</li><li>Scheduler è¿›è¡Œå¼‚æ­¥è°ƒåº¦</li></ol><h2 id="æ¸²æŸ“å‰¯ä½œç”¨-å»ºç«‹è§†å›¾ä¸æ•°æ®çš„å“åº”å…³è”" tabindex="-1"><a class="header-anchor" href="#æ¸²æŸ“å‰¯ä½œç”¨-å»ºç«‹è§†å›¾ä¸æ•°æ®çš„å“åº”å…³è”" aria-hidden="true">#</a> æ¸²æŸ“å‰¯ä½œç”¨ï¼šå»ºç«‹è§†å›¾ä¸æ•°æ®çš„å“åº”å…³è”</h2><p>å›é¡¾ vue ç»„ä»¶æ¸²æŸ“æµç¨‹ï¼š</p><ol><li>åˆ›å»ºç»„ä»¶ç±»å‹ vnode</li><li>æ¸²æŸ“ vnode <ol><li>åˆ›å»ºç»„ä»¶å®ä¾‹</li><li>åˆå§‹åŒ–ç»„ä»¶</li><li>åˆ›å»ºç»„ä»¶æ¸²æŸ“å‰¯ä½œç”¨å¹¶æ‰§è¡Œ</li></ol></li></ol><blockquote><p>æ›´å¤šå‚è€ƒ <a href="/Vue/vue%20%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B.html" class="">vue ç»„ä»¶æ¸²æŸ“æµç¨‹</a>ã€‚</p></blockquote><p>é€šè¿‡ setupRenderEffect åˆ›å»ºæ¸²æŸ“å‰¯ä½œç”¨å¹¶æ‰§è¡Œã€‚</p><div class="language-typescript ext-ts"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#6E7781;">// packages/runtime-core/src/renderer.ts</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">setupRenderEffect</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">SetupRenderEffectFn</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">instance</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">initialVNode</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">container</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">anchor</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">parentSuspense</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">isSVG</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#953800;">optimized</span></span>
<span class="line"><span style="color:#24292F;">  ) </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// ç»„ä»¶æ›´æ–°å‡½æ•°</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">componentUpdateFn</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> () </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> { </span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">//...</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// æ‰§è¡Œç»„ä»¶ render æ–¹æ³•</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">//...</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// create reactive effect for rendering</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// åˆ›å»ºå“åº”å¼æ¸²æŸ“å‰¯ä½œç”¨</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">effect</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">new</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">ReactiveEffect</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">      componentUpdateFn,</span></span>
<span class="line"><span style="color:#24292F;">      () </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">queueJob</span><span style="color:#24292F;">(instance.update),</span></span>
<span class="line"><span style="color:#24292F;">      instance.scope </span><span style="color:#6E7781;">// track it in component&#39;s effect scope</span></span>
<span class="line"><span style="color:#24292F;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">update</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (instance.update </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> effect.run.</span><span style="color:#8250DF;">bind</span><span style="color:#24292F;">(effect) </span><span style="color:#CF222E;">as</span><span style="color:#24292F;"> </span><span style="color:#953800;">SchedulerJob</span><span style="color:#24292F;">)</span></span>
<span class="line"><span style="color:#24292F;">    update.id </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> instance.uid</span></span>
<span class="line"><span style="color:#24292F;">   </span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">//...</span></span>
<span class="line"><span style="color:#24292F;">    </span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// æ‰§è¡Œæ¸²æŸ“ã€è§¦å‘ä¾èµ–æ”¶é›†</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#8250DF;">update</span><span style="color:#24292F;">()</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"></span></code></pre></div><p>å…¶ä¸­æœ€ä¸»è¦çš„æ˜¯æ‰§è¡Œç»„ä»¶çš„<strong>æ¸²æŸ“å‡½æ•°</strong>ï¼Œ<strong>æ¸²æŸ“å‡½æ•°æ˜¯è§†å›¾è®¿é—®æ•°æ®ï¼Œå»ºç«‹å“åº”å¼å…³è”çš„å…³é”®æ‰€åœ¨</strong>ã€‚</p><p>å¯ä»¥é€šè¿‡çº¿ä¸Š<a href="https://vue-next-template-explorer.netlify.app/" target="_blank" rel="noopener noreferrer">æ¨¡æ¿ç¼–è¯‘å™¨<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼ŒæŸ¥çœ‹ç¼–è¯‘åçš„æ¸²æŸ“å‡½æ•°ã€‚</p><div class="language-html ext-html"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#24292F;">&lt;</span><span style="color:#116329;">div</span><span style="color:#24292F;">&gt;{{name}}&lt;/</span><span style="color:#116329;">div</span><span style="color:#24292F;">&gt;</span></span>
<span class="line"></span></code></pre></div><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#CF222E;">import</span><span style="color:#24292F;"> { toDisplayString </span><span style="color:#CF222E;">as</span><span style="color:#24292F;"> _toDisplayString, openBlock </span><span style="color:#CF222E;">as</span><span style="color:#24292F;"> _openBlock, createElementBlock </span><span style="color:#CF222E;">as</span><span style="color:#24292F;"> _createElementBlock } </span><span style="color:#CF222E;">from</span><span style="color:#24292F;"> </span><span style="color:#0A3069;">&quot;vue&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CF222E;">export</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">render</span><span style="color:#24292F;">(</span><span style="color:#953800;">_ctx</span><span style="color:#24292F;">, </span><span style="color:#953800;">_cache</span><span style="color:#24292F;">, </span><span style="color:#953800;">$props</span><span style="color:#24292F;">, </span><span style="color:#953800;">$setup</span><span style="color:#24292F;">, </span><span style="color:#953800;">$data</span><span style="color:#24292F;">, </span><span style="color:#953800;">$options</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> (</span><span style="color:#8250DF;">_openBlock</span><span style="color:#24292F;">(), </span><span style="color:#8250DF;">_createElementBlock</span><span style="color:#24292F;">(</span><span style="color:#0A3069;">&quot;div&quot;</span><span style="color:#24292F;">, </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">, </span><span style="color:#8250DF;">_toDisplayString</span><span style="color:#24292F;">(_ctx.name), </span><span style="color:#0550AE;">1</span><span style="color:#24292F;"> </span><span style="color:#6E7781;">/* TEXT */</span><span style="color:#24292F;">))</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span></code></pre></div><p>è®¿é—® name æ—¶å¾—é€šè¿‡ <code>_ctx.name</code>ï¼Œ<strong>ctx æ˜¯æ•°æ®è®¿é—®çš„ä¸Šä¸‹æ–‡ç¯å¢ƒä»£ç†</strong>ã€‚</p><h2 id="æ¸²æŸ“ä¸Šä¸‹æ–‡-è§†å›¾çš„æ•°æ®è®¿é—®ä»£ç†" tabindex="-1"><a class="header-anchor" href="#æ¸²æŸ“ä¸Šä¸‹æ–‡-è§†å›¾çš„æ•°æ®è®¿é—®ä»£ç†" aria-hidden="true">#</a> æ¸²æŸ“ä¸Šä¸‹æ–‡ï¼šè§†å›¾çš„æ•°æ®è®¿é—®ä»£ç†</h2><p>ç»Ÿä¸€ä»£ç†è®¿é—®ï¼Œä¸»è¦æ˜¯å› ä¸ºè§†å›¾è®¿é—®çš„æ•°æ®æºæœ‰å¤šå¤„ï¼š</p><ol><li>setupState</li><li>data</li><li>props</li><li>ç”¨æˆ·è‡ªå®šä¹‰æ·»åŠ åœ¨å®ä¾‹ä¸Šçš„å±æ€§ <code>this.xxx = xxx</code></li><li>ç»„ä»¶å®ä¾‹ vue å…¬å¼€æ–¹æ³•ï¼šå¦‚ <code>$options</code>ã€<code>$refs</code> ç­‰</li><li>å…¨å±€å±æ€§ï¼š <code>app.config.globalProperties</code> é…ç½®</li></ol><blockquote><p>æºç ä½ç½®ï¼š packages/runtime-core/src/componentPublicInstance.ts @PublicInstanceProxyHandlers</p></blockquote><p>ğŸ’¡ æ•°æ®è®¿é—®é¡ºåºçš„å½±å“ï¼Œä¸‹é¢ç¤ºä¾‹å°†è¾“å‡º setup çš„ msgã€‚</p><div class="language-vue ext-vue"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#24292F;">&lt;</span><span style="color:#116329;">template</span><span style="color:#24292F;">&gt;</span></span>
<span class="line"><span style="color:#24292F;">  &lt;</span><span style="color:#0550AE;">p</span><span style="color:#24292F;">&gt;{{</span><span style="color:#0550AE;">msg</span><span style="color:#24292F;">}}&lt;/</span><span style="color:#0550AE;">p</span><span style="color:#24292F;">&gt;</span></span>
<span class="line"><span style="color:#24292F;">&lt;/</span><span style="color:#116329;">template</span><span style="color:#24292F;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">&lt;</span><span style="color:#116329;">script</span><span style="color:#24292F;">&gt;</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">import</span><span style="color:#24292F;"> { ref } </span><span style="color:#CF222E;">from</span><span style="color:#24292F;"> </span><span style="color:#0A3069;">&#39;vue&#39;</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">export</span><span style="color:#953800;"> </span><span style="color:#CF222E;">default</span><span style="color:#953800;"> {</span></span>
<span class="line"><span style="color:#953800;">    </span><span style="color:#8250DF;">data</span><span style="color:#953800;">() </span><span style="color:#24292F;">{</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">        msg: </span><span style="color:#0A3069;">&#39;msg from data&#39;</span></span>
<span class="line"><span style="color:#24292F;">      }</span></span>
<span class="line"><span style="color:#24292F;">    }</span><span style="color:#953800;">,</span></span>
<span class="line"><span style="color:#953800;">    </span><span style="color:#8250DF;">setup</span><span style="color:#953800;">() </span><span style="color:#24292F;">{</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">msg</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">ref</span><span style="color:#24292F;">(</span><span style="color:#0A3069;">&#39;msg from setup&#39;</span><span style="color:#24292F;">)</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">        msg</span></span>
<span class="line"><span style="color:#24292F;">      }</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#953800;">  }</span></span>
<span class="line"><span style="color:#24292F;">&lt;/</span><span style="color:#116329;">script</span><span style="color:#24292F;">&gt;</span></span>
<span class="line"></span></code></pre></div><h3 id="æ¸²æŸ“ä¸Šä¸‹æ–‡ç›¸å…³æºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#æ¸²æŸ“ä¸Šä¸‹æ–‡ç›¸å…³æºç åˆ†æ" aria-hidden="true">#</a> æ¸²æŸ“ä¸Šä¸‹æ–‡ç›¸å…³æºç åˆ†æ</h3><p>åˆ›å»ºç»„ä»¶å®ä¾‹æ—¶ç”Ÿæˆæ¸²æŸ“ä¸Šä¸‹æ–‡ã€‚</p><div class="language-typescript ext-ts"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#6E7781;">// packages/runtime-core/src/component.ts@createComponentInstance</span></span>
<span class="line"><span style="color:#CF222E;">export</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">createComponentInstance</span><span style="color:#24292F;">(){</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// ...</span></span>
<span class="line"><span style="color:#24292F;">  instance.ctx </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> { _: instance }</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// ...</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> instance</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span></code></pre></div><p>åˆ›å»ºæ¸²æŸ“ä¸Šä¸‹æ–‡ä»£ç† <code>instance.proxy</code>ï¼Œå¹¶ä½¿ç”¨ accessCache å±æ€§ä»£ç†è®¿é—®ç¼“å­˜ï¼Œå› ä¸ºæ¯æ¬¡ä»£ç†è®¿é—®æ•°æ®éƒ½è¦ç»è¿‡å¤šå¤„æ•°æ®æºåˆ¤æ–­ã€‚</p><blockquote><p>æºç ä½ç½®ï¼š packages/runtime-core/src/componentPublicInstance.ts @PublicInstanceProxyHandlers</p></blockquote><p>ç¼“å­˜ key å’Œå¯¹åº”çš„æ•°æ®æºï¼Œèƒ½å¤Ÿç›´è¾¾è®¿é—®ï¼Œå‡å°‘å¾ˆå¤šåˆ¤æ–­ï¼Œæ€§èƒ½æå‡ã€‚</p><div class="language-typescript ext-ts"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#6E7781;">// mountComponent =&gt; setupComponent =&gt; setupStatefulComponent</span></span>
<span class="line"><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">setupStatefulComponent</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">instance</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">ComponentInternalInstance</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">isSSR</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">boolean</span></span>
<span class="line"><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">Component</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> instance.type </span><span style="color:#CF222E;">as</span><span style="color:#24292F;"> </span><span style="color:#953800;">ComponentOptions</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// 0. create render proxy property access cache</span></span>
<span class="line"><span style="color:#24292F;">  instance.accessCache </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">Object</span><span style="color:#24292F;">.</span><span style="color:#8250DF;">create</span><span style="color:#24292F;">(</span><span style="color:#0550AE;">null</span><span style="color:#24292F;">)</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// 1. create public instance / render proxy</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// also mark it raw so it&#39;s never observed</span></span>
<span class="line"><span style="color:#24292F;">  instance.proxy </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">markRaw</span><span style="color:#24292F;">(</span><span style="color:#CF222E;">new</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">Proxy</span><span style="color:#24292F;">(instance.ctx, PublicInstanceProxyHandlers))</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (__DEV__) {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#8250DF;">exposePropsOnRenderContext</span><span style="color:#24292F;">(instance)</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// 2. call setup()</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> { </span><span style="color:#0550AE;">setup</span><span style="color:#24292F;"> } </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> Component</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (setup) {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// æ‰§è¡Œ setup ... </span></span>
<span class="line"><span style="color:#24292F;">  } </span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span></code></pre></div><p>æ‰§è¡Œæ¸²æŸ“å‡½æ•°å¹¶åº”ç”¨æ¸²æŸ“ä¸Šä¸‹æ–‡ã€‚</p><div class="language-typescript ext-ts"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#CF222E;">export</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">renderComponentRoot</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">instance</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">ComponentInternalInstance</span></span>
<span class="line"><span style="color:#24292F;">)</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#CF222E;">const</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#953800;">type</span><span style="color:#24292F;">: </span><span style="color:#0550AE;">Component</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#0550AE;">vnode</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#0550AE;">proxy</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#0550AE;">withProxy</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#0550AE;">props</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#953800;">propsOptions</span><span style="color:#24292F;">: [</span><span style="color:#0550AE;">propsOptions</span><span style="color:#24292F;">],</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#0550AE;">slots</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#0550AE;">attrs</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#0550AE;">emit</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#0550AE;">render</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#0550AE;">renderCache</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#0550AE;">data</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#0550AE;">setupState</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#0550AE;">ctx</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#0550AE;">inheritAttrs</span></span>
<span class="line"><span style="color:#24292F;">} </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> instance</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CF222E;">let</span><span style="color:#24292F;"> result</span></span>
<span class="line"><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">prev</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">setCurrentRenderingInstance</span><span style="color:#24292F;">(instance)</span></span>
<span class="line"><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (__DEV__) {</span></span>
<span class="line"><span style="color:#24292F;"> accessedAttrs </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">false</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"><span style="color:#CF222E;">try</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#CF222E;">let</span><span style="color:#24292F;"> fallthroughAttrs</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (vnode.shapeFlag </span><span style="color:#CF222E;">&amp;</span><span style="color:#24292F;"> ShapeFlags.</span><span style="color:#0550AE;">STATEFUL_COMPONENT</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">   </span><span style="color:#6E7781;">// withProxy is a proxy with a different `has` trap only for</span></span>
<span class="line"><span style="color:#24292F;">   </span><span style="color:#6E7781;">// runtime-compiled render functions using `with` block.</span></span>
<span class="line"><span style="color:#24292F;">   </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">proxyToUse</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> withProxy </span><span style="color:#CF222E;">||</span><span style="color:#24292F;"> proxy</span></span>
<span class="line"><span style="color:#24292F;">   result </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">normalizeVNode</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">     render</span><span style="color:#CF222E;">!</span><span style="color:#24292F;">.</span><span style="color:#8250DF;">call</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">       proxyToUse,</span></span>
<span class="line"><span style="color:#24292F;">       proxyToUse</span><span style="color:#CF222E;">!</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">       renderCache,</span></span>
<span class="line"><span style="color:#24292F;">       props,</span></span>
<span class="line"><span style="color:#24292F;">       setupState,</span></span>
<span class="line"><span style="color:#24292F;">       data,</span></span>
<span class="line"><span style="color:#24292F;">       ctx</span></span>
<span class="line"><span style="color:#24292F;">     )</span></span>
<span class="line"><span style="color:#24292F;">   )</span></span>
<span class="line"><span style="color:#24292F;">   fallthroughAttrs </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> attrs</span></span>
<span class="line"><span style="color:#24292F;"> } </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">   </span><span style="color:#6E7781;">// functional</span></span>
<span class="line"><span style="color:#24292F;">   </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">render</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> Component </span><span style="color:#CF222E;">as</span><span style="color:#24292F;"> </span><span style="color:#953800;">FunctionalComponent</span></span>
<span class="line"><span style="color:#24292F;">   </span></span>
<span class="line"><span style="color:#24292F;">   result </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">normalizeVNode</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">     render.</span><span style="color:#0550AE;">length</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">&gt;</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">1</span></span>
<span class="line"><span style="color:#24292F;">       </span><span style="color:#CF222E;">?</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">render</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">           props,</span></span>
<span class="line"><span style="color:#24292F;">           __DEV__</span></span>
<span class="line"><span style="color:#24292F;">             </span><span style="color:#CF222E;">?</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">                 </span><span style="color:#CF222E;">get</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">attrs</span><span style="color:#24292F;">() {</span></span>
<span class="line"><span style="color:#24292F;">                   </span><span style="color:#8250DF;">markAttrsAccessed</span><span style="color:#24292F;">()</span></span>
<span class="line"><span style="color:#24292F;">                   </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> attrs</span></span>
<span class="line"><span style="color:#24292F;">                 },</span></span>
<span class="line"><span style="color:#24292F;">                 slots,</span></span>
<span class="line"><span style="color:#24292F;">                 emit</span></span>
<span class="line"><span style="color:#24292F;">               }</span></span>
<span class="line"><span style="color:#24292F;">             </span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> { attrs, slots, emit }</span></span>
<span class="line"><span style="color:#24292F;">         )</span></span>
<span class="line"><span style="color:#24292F;">       </span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">render</span><span style="color:#24292F;">(props, </span><span style="color:#0550AE;">null</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">as</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">any</span><span style="color:#24292F;"> </span><span style="color:#6E7781;">/* we know it doesn&#39;t need it */</span><span style="color:#24292F;">)</span></span>
<span class="line"><span style="color:#24292F;">   )</span></span>
<span class="line"><span style="color:#24292F;"> }</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#6E7781;">//...</span></span>
<span class="line"><span style="color:#24292F;">} </span></span>
<span class="line"></span></code></pre></div><ol><li>å‚æ•°ä¼ é€’æ–¹å¼ï¼Œä¸Šé¢æ¨¡æ¿ç¼–è¯‘ä¾‹å­ä¸­ç»è¿‡æ¨¡æ¿ç¼–è¯‘çš„æ¸²æŸ“å‡½æ•°å³å¯é€šè¿‡å‚æ•° ctx ä»£ç†è®¿é—®æ•°æ®</li><li>this ç»‘å®šï¼Œåœ¨è‡ªå®šä¹‰çš„ render é‡Œå¯é€šè¿‡ this è®¿é—®æ•°æ®<div class="language-jsx ext-jsx"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#24292F;">{</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#8250DF;">render</span><span style="color:#24292F;">() {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> &lt;</span><span style="color:#116329;">div</span><span style="color:#24292F;">&gt;{ </span><span style="color:#0550AE;">this</span><span style="color:#24292F;">.name }&lt;/</span><span style="color:#116329;">div</span><span style="color:#24292F;">&gt;</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span></code></pre></div></li></ol><h3 id="proxy-å’Œ-withproxy" tabindex="-1"><a class="header-anchor" href="#proxy-å’Œ-withproxy" aria-hidden="true">#</a> proxy å’Œ withProxy</h3><p>åœ¨çœ‹ vue æºç è¿‡ç¨‹å‘ç°ç»„ä»¶å±æ€§ä¸Šä¸ºä»€ä¹ˆæœ‰ä¸¤ä¸ªæ¸²æŸ“ä¸Šä¸‹æ–‡ä»£ç† proxy å’Œ withProxyã€‚</p><div class="language-typescript ext-ts"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#CF222E;">export</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">interface</span><span style="color:#24292F;"> </span><span style="color:#953800;">ComponentInternalInstance</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// main proxy that serves as the public instance (`this`)</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">proxy</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">ComponentPublicInstance</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">/**</span></span>
<span class="line"><span style="color:#6E7781;">   * alternative proxy used only for runtime-compiled render functions using</span></span>
<span class="line"><span style="color:#6E7781;">   * `with` block</span></span>
<span class="line"><span style="color:#6E7781;">   * </span><span style="color:#CF222E;">@internal</span></span>
<span class="line"><span style="color:#6E7781;">   */</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">withProxy</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">ComponentPublicInstance</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// ...</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span></code></pre></div><p>withProxy æ˜¯é’ˆå¯¹åŠ¨æ€æ¨¡æ¿ç¼–è¯‘çš„åœºæ™¯ã€‚</p><p>éšæ‰‹å†™äº†ä¸¤ä¸ªç»„ä»¶ï¼Œä¸€ä¸ªæ˜¯åŠ¨æ€æ¨¡æ¿ç¼–è¯‘ä¸€ä¸ªæ˜¯ SFC ç»„ä»¶ç¼–è¯‘ï¼Œå¹¶æ‰“å°äº†å…¶æ¸²æŸ“å‡½æ•°ã€‚</p><p><img src="/assets/img/47baf14950ffeb8be704d559277b00b7ceda6ffc41a854e4a93bab241931c8f1.4c544977.png" alt="å›¾ 4"></p><p>ä½¿ç”¨æ¨¡æ¿ DSL æœ€å¤§çš„ä¸€ç‚¹å°±æ˜¯é™åˆ¶ç”¨æˆ·å†™æ³•ï¼Œä»è€Œæä¾›å®‰å…¨åŠæ€§èƒ½ã€‚</p><blockquote><p>vue çš„æ¨¡æ¿è¡¨è¾¾å¼éƒ½è¢«æ”¾åœ¨æ²™ç›’ä¸­ï¼Œåªèƒ½è®¿é—®ä¸€ä¸ªå—é™çš„<a href="https://github.com/vuejs/vue-next/blob/master/packages/shared/src/globalsWhitelist.ts#L3" target="_blank" rel="noopener noreferrer">å…¨å±€å˜é‡åˆ—è¡¨<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼Œå¦‚ Math å’Œ Dateã€‚ä½ ä¸åº”è¯¥åœ¨æ¨¡æ¿è¡¨è¾¾å¼ä¸­è¯•å›¾è®¿é—®ç”¨æˆ·å®šä¹‰çš„å…¨å±€å˜é‡ï¼Œå°±ä¸Šé¢ç¤ºä¾‹è®¿é—®å…¨å±€å˜é‡ historyã€‚</p></blockquote><p>ä½†æœ‰ä¸€ç‚¹è®©æˆ‘æ„Ÿåˆ°å›°æƒ‘çš„æ˜¯ä¸ºä»€ä¹ˆä¸¤è€…ç¼–è¯‘åçš„ä»£ç ä¸ç›¸åŒï¼Œä¸€ä¸ªé€šè¿‡ä½œç”¨åŸŸé“¾ä¸€ä¸ªé€šè¿‡åŸå‹é“¾è®¿é—®ï¼Œç†è®ºä¸Šæ¥è¯´ä¸¤è€…å¯è¾¾åˆ°åŒæ ·çš„ç›®çš„æ•ˆæœï¼Œé‚£ä¸ºä»€ä¹ˆä¸ç»Ÿä¸€ä½¿ç”¨ä¸‹é¢çš„æ–¹å¼ï¼Ÿ</p><p><strong>è¿™é‡Œæœ‰ä¸ªå°æŠ€å·§ï¼šçœ‹æºç è¿‡ç¨‹ä¸€èˆ¬å»ºè®®å…³æ³¨ä¸»çº¿é€»è¾‘ï¼Œåƒå„ç§ç‰¹æ®Šæƒ…å†µå¯é€šè¿‡æ³¨é‡Šã€commit messageã€issue æˆ–è€…æµ‹è¯•ç”¨ä¾‹æŸ¥çœ‹åŸç”±</strong>ã€‚</p><p>æºç ä¸­æ¨¡æ¿è¡¨è¾¾å¼çš„å¤„ç†é€»è¾‘ï¼š</p><div class="language-typescript ext-ts"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#6E7781;">// packages/compiler-core/src/transforms/transformExpression.ts@processExpression</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6E7781;">// Important: since this function uses Node.js only dependencies, it should</span></span>
<span class="line"><span style="color:#6E7781;">// always be used with a leading !__BROWSER__ check so that it can be</span></span>
<span class="line"><span style="color:#6E7781;">// tree-shaken from the browser build.</span></span>
<span class="line"><span style="color:#CF222E;">export</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">processExpression</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">node</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">SimpleExpressionNode</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">context</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">TransformContext</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// some expressions like v-slot props &amp; v-for aliases should be parsed as</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// function params</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">asParams</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">false</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// v-on handler values may contain multiple statements</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">asRawStatements</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">false</span></span>
<span class="line"><span style="color:#24292F;">)</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">ExpressionNode</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (__BROWSER__) {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (__DEV__) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// simple in-browser validation (same logic in 2.x)</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#8250DF;">validateBrowserExpression</span><span style="color:#24292F;">(node, context, asParams, asRawStatements)</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> node</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// `__BROWSER__` ç¯å¢ƒä¸‹ï¼Œä¸‹é¢ä»£ç ä¼šè¢«åˆ é™¤</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// ....</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">needPrefix</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">shouldPrefix</span><span style="color:#24292F;">(node, parent</span><span style="color:#CF222E;">!</span><span style="color:#24292F;">, parentStack)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">//...</span></span>
<span class="line"></span></code></pre></div><p>æ­£å¸¸æœ¬åœ° AOT ç¼–è¯‘çš„æƒ…å†µä¸‹è¯¥å‡½æ•°ä¼šæ‰§è¡Œåˆ° <code>shouldPrefix</code> æ–¹æ³•ï¼Œè¯¥å‡½æ•°ä¼šæ ¹æ®å…¨å±€å˜é‡ç™½åå•åˆ¤æ–­æ˜¯å¦è¦æ·»åŠ  <code>_ctx.</code> å‰ç¼€ã€‚æ¯”å¦‚ history æ˜¯ç¦æ­¢çš„ï¼Œé‚£ä¹ˆå°±é™åˆ¶åœ¨ _ctx çš„åŸå‹é“¾ä¸ŠæŸ¥æ‰¾ï¼Œå¦åˆ™å¯é€šè¿‡ä½œç”¨åŸŸé“¾åˆ°å…¨å±€æŸ¥æ‰¾ã€‚</p><p>ä½†åœ¨çº¿ä¸Šæµè§ˆå™¨ä¸­åŠ¨æ€ç¼–è¯‘æ—¶ï¼Œæ‰“åŒ…ç¼–è¯‘å™¨ä»£ç ä¼šæŠŠåŒ…å« <code>@babel/parse</code> ä»£ç ç»™åŒ…å«è¿›å»ï¼Œè¿™å°±å¯¼è‡´æ•´ä¸ª complie runtime å¾ˆå¤§ï¼ˆæœ‰ä¸ªç›¸å…³ <a href="https://github.com/vuejs/vue-next/issues/2515" target="_blank" rel="noopener noreferrer">issue<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> è®¨è®ºï¼‰ã€‚æ‰€ä»¥åœ¨ <code>__BROWSER__</code> ç¯å¢ƒä¸‹é€šè¿‡ tree-shaking åˆ é™¤ä»£ç ï¼Œè¿™æ ·å­è¡¨è¾¾å¼ç›¸å½“äºä¸åšå¤„ç†ç›´æ¥è¿”å›ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•é™åˆ¶ history ï¼Ÿå°±åªèƒ½é€šè¿‡ <code>with</code> é™åˆ¶ä½œç”¨é“¾æŸ¥æ‰¾ã€‚å¯¹äºä½¿ç”¨ with å—è¿è¡Œæ—¶ç¼–è¯‘çš„æ¸²æŸ“å‡½æ•°ï¼Œæ¸²æŸ“ä¸Šä¸‹æ–‡çš„ä»£ç†æ˜¯ RuntimeCompiledPublicInstanceProxyHandlersã€‚å®ƒæ˜¯åœ¨ä¹‹å‰æ¸²æŸ“ä¸Šä¸‹æ–‡ä»£ç† PublicInstanceProxyHandlers çš„åŸºç¡€ä¸Šè¿›è¡Œçš„æ‰©å±•ï¼Œä¸»è¦å¯¹ has å‡½æ•°çš„å®ç°åšäº†ä¼˜åŒ–ï¼š</p><div class="language-typescript ext-ts"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#6E7781;">// packages/runtime-core/src/componentPublicInstance.ts@RuntimeCompiledPublicInstanceProxyHandlers</span></span>
<span class="line"><span style="color:#CF222E;">export</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">RuntimeCompiledPublicInstanceProxyHandlers</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#6E7781;">/*#__PURE__*/</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">extend</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">  {},</span></span>
<span class="line"><span style="color:#24292F;">  PublicInstanceProxyHandlers,</span></span>
<span class="line"><span style="color:#24292F;">  {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#8250DF;">get</span><span style="color:#24292F;">(</span><span style="color:#953800;">target</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">ComponentRenderContext</span><span style="color:#24292F;">, </span><span style="color:#953800;">key</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">string</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// fast path for unscopables when using `with` block</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> ((key </span><span style="color:#CF222E;">as</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">any</span><span style="color:#24292F;">) </span><span style="color:#CF222E;">===</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">Symbol</span><span style="color:#24292F;">.unscopables) {</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">return</span></span>
<span class="line"><span style="color:#24292F;">      }</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> PublicInstanceProxyHandlers.</span><span style="color:#8250DF;">get</span><span style="color:#CF222E;">!</span><span style="color:#24292F;">(target, key, target)</span></span>
<span class="line"><span style="color:#24292F;">    },</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#8250DF;">has</span><span style="color:#24292F;">(</span><span style="color:#953800;">_</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">ComponentRenderContext</span><span style="color:#24292F;">, </span><span style="color:#953800;">key</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">string</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">has</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> key[</span><span style="color:#0550AE;">0</span><span style="color:#24292F;">] </span><span style="color:#CF222E;">!==</span><span style="color:#24292F;"> </span><span style="color:#0A3069;">&#39;_&#39;</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">&amp;&amp;</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">!</span><span style="color:#8250DF;">isGloballyWhitelisted</span><span style="color:#24292F;">(key)</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (__DEV__ </span><span style="color:#CF222E;">&amp;&amp;</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">!</span><span style="color:#24292F;">has </span><span style="color:#CF222E;">&amp;&amp;</span><span style="color:#24292F;"> PublicInstanceProxyHandlers.</span><span style="color:#8250DF;">has</span><span style="color:#CF222E;">!</span><span style="color:#24292F;">(_, key)) {</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#8250DF;">warn</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#0A3069;">`Property ${</span><span style="color:#0550AE;">JSON</span><span style="color:#0A3069;">.</span><span style="color:#0550AE;">stringify</span><span style="color:#0A3069;">(</span></span>
<span class="line"><span style="color:#0A3069;">            </span><span style="color:#24292F;">key</span></span>
<span class="line"><span style="color:#0A3069;">          )</span><span style="color:#0A3069;">} should not start with _ which is a reserved prefix for Vue internals.`</span></span>
<span class="line"><span style="color:#24292F;">        )</span></span>
<span class="line"><span style="color:#24292F;">      }</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> has</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"><span style="color:#24292F;">)</span></span>
<span class="line"></span></code></pre></div><p>è¿™é‡Œå¦‚æœ key ä»¥ _ å¼€å¤´ï¼Œæˆ–è€… key åœ¨å…¨å±€å˜é‡çš„ç™½åå•å†…ï¼Œåˆ™ has ä¸º falseï¼Œæ­¤æ—¶åˆ™ç›´æ¥å‘½ä¸­è­¦å‘Šï¼Œä¸ç”¨å†è¿›è¡Œä¹‹å‰é‚£ä¸€ç³»åˆ—çš„åˆ¤æ–­äº†ã€‚</p><h2 id="å¼‚æ­¥æ›´æ–°æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#å¼‚æ­¥æ›´æ–°æœºåˆ¶" aria-hidden="true">#</a> å¼‚æ­¥æ›´æ–°æœºåˆ¶</h2><p>å½“å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶å¹¶ä¸ä¼šç«‹å³æ›´æ–°è§†å›¾ï¼Œè€Œæ˜¯å°†è§†å›¾æ›´æ–°ä»»åŠ¡æ´¾å‘ç»™<strong>è°ƒåº¦å™¨</strong>è°ƒåº¦æ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ vue çš„è§†å›¾æ›´æ–°æ˜¯å¼‚æ­¥çš„ï¼Œè¿™æ˜¯å› ä¸ºå½“ä½ æœ‰å¤šä¸ªå“åº”å¼æ•°æ®ä¿®æ”¹çš„æ—¶å€™ï¼Œä¸å¯èƒ½æ¯ä¿®æ”¹ä¸€ä¸ªå°±åŒæ­¥ä¸€æ¬¡æ›´æ–°æ“ä½œï¼Œè€Œæ˜¯å°†æ‰€æœ‰çš„æ›´æ–°ä»»åŠ¡éƒ½ç¼“å†²åˆ°ä¸‹ä¸€ä¸ª tick ä¸­å»æ‰§è¡Œã€‚</p><div class="language-typescript ext-ts"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#6E7781;">// packages/runtime-core/src/scheduler.ts</span></span>
<span class="line"><span style="color:#6E7781;">// ...</span></span>
<span class="line"><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">effect</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">new</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">ReactiveEffect</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">      componentUpdateFn, </span><span style="color:#6E7781;">// ç»„ä»¶æ¸²æŸ“å‡½æ•°</span></span>
<span class="line"><span style="color:#24292F;">      () </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">queueJob</span><span style="color:#24292F;">(instance.update), </span><span style="color:#6E7781;">// æ”¾è¿›ä»»åŠ¡é˜Ÿåˆ—</span></span>
<span class="line"><span style="color:#24292F;">      instance.scope </span><span style="color:#6E7781;">// track it in component&#39;s effect scope</span></span>
<span class="line"><span style="color:#24292F;">    )</span></span>
<span class="line"><span style="color:#6E7781;">//...</span></span>
<span class="line"></span></code></pre></div><p>è§†å›¾æ›´æ–°ä»»åŠ¡éƒ½ä¼šæ”¾è¿›å¼‚æ­¥é˜Ÿåˆ—ã€‚ä½†ä¸ºäº†ä¿è¯æ¸²æŸ“ä¸€è‡´æ€§ï¼Œvue æ ¹æ®æ¸²æŸ“å‰ååˆ†ä¸ºäº†ä¸åŒé˜Ÿåˆ—ï¼š</p><ul><li>pendingPreFlushCbsï¼ˆpre queueï¼‰</li><li>queueï¼ˆrender queueï¼‰</li><li>pendingPostFlushCbsï¼ˆpost queueï¼‰</li></ul><p>vue3 ä¸ºå¼€å‘è€…æä¾›äº†æ–¹ä¾¿çš„å¯å˜æ•°æ®åŠŸèƒ½ï¼Œå´å¤æ‚äº†è‡ªå·±å†…éƒ¨å®ç°ã€‚ç›¸æ¯” vue2 æ—¶æœŸç›´æ¥å°†æ›´æ–°ä»»åŠ¡æ”¾åˆ°å•ä¸ªå¼‚æ­¥é˜Ÿåˆ—è€Œè¨€ï¼Œvue3 åˆ™æ˜¯å¤šä¼˜å…ˆçº§é˜Ÿåˆ— + è°ƒåº¦æœºåˆ¶ï¼Œå› ä¸ºå“åº”å¼è§¦å‘çš„å¤šä¸ªè§‚å¯Ÿè€…éœ€è¦ä¿è¯ä»–ä»¬æŒ‰ç…§é¢„æœŸæ•ˆæœæ‰§è¡Œå°±éœ€è¦è¿›è¡Œè°ƒåº¦ä»»åŠ¡ã€‚</p><p>å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ä¼šè§¦å‘ä¸‰ç±»ä»»åŠ¡åˆ†åˆ«æ˜¯ watcherã€renderã€effectã€‚</p><p><img src="/assets/img/0fbc7dac1c4b4892205a65308aa3cdc7e82cb3aaf09fa57e1125ccfc7058d817.79a3a844.png" alt="å›¾ 16"></p><p>å…¶ä¸­ effect æ˜¯åº•å±‚å“åº”å¼å‰¯ä½œç”¨ api ç”Ÿæˆçš„ï¼Œæ˜¯å“åº”å¼åŒæ­¥è§¦å‘ï¼›è€Œ render å’Œ watcher æ˜¯ effect åŸºç¡€ä¸Šå®ç°çš„ï¼Œæ˜¯ç»™å¼€å‘è€…ä»¬ä¼˜å…ˆä½¿ç”¨çš„ï¼Œå¹¶ä¸”æ¥å…¥è°ƒåº¦æœºåˆ¶ä¸­ã€‚</p><p>render ä»»åŠ¡æ˜¯å­˜æ”¾è¿› render queue ä¸­ï¼Œwatcher åˆ™å¯æ ¹æ®å±æ€§æ§åˆ¶ï¼š</p><ul><li>pre å¯¹åº” pre queue</li><li>post å¯¹åº” post queue</li><li>sync ç›´æ¥åŒæ­¥æ‰§è¡Œ</li></ul><p>äº†è§£äº†ä»»åŠ¡ç±»å‹åŠå¯¹åº”çš„ä»»åŠ¡é˜Ÿåˆ—åï¼Œæˆ‘ä»¬å†äº†è§£ vue æ˜¯å¦‚ä½•å¼‚æ­¥æ›´æ–°ï¼Œå…¶å®å¾ˆç®€å•ï¼š <strong>åœ¨åŒä¸€ä¸ª tick ä¸­å¯¹è§¦å‘çš„ watcherã€render ä»»åŠ¡ç”¨å¯¹åº”çš„ä»»åŠ¡é˜Ÿåˆ—è¿›è¡Œç¼“å†²æ”¶é›†å¹¶ä¸”åœ¨è¿è¡Œæ—¶ç¯å¢ƒåˆ›å»ºä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ç”¨äºè´Ÿè´£æ‰§è¡Œè¿™äº›æ›´æ–°ä»»åŠ¡</strong>ã€‚</p><div class="language-typescript ext-ts"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#6E7781;">// queueJob å°†å¼‚æ­¥æ›´æ–°ä»»åŠ¡æ’å…¥åˆ° render queue é˜Ÿåˆ—ä¸­</span></span>
<span class="line"><span style="color:#CF222E;">export</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">queueJob</span><span style="color:#24292F;">(</span><span style="color:#953800;">job</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">SchedulerJob</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// çœç•¥...</span></span>
<span class="line"><span style="color:#24292F;">  ) {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// æ’å…¥é˜Ÿåˆ—</span></span>
<span class="line"><span style="color:#24292F;">    queue.</span><span style="color:#8250DF;">push</span><span style="color:#24292F;">(job)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#8250DF;">queueFlush</span><span style="color:#24292F;">()  </span><span style="color:#6E7781;">// å‘è¿è¡Œæ—¶ç¯å¢ƒå‘èµ·ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">queueFlush</span><span style="color:#24292F;">() {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// é˜²æ­¢é‡å¤è§¦å‘</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (</span><span style="color:#CF222E;">!</span><span style="color:#24292F;">isFlushing </span><span style="color:#CF222E;">&amp;&amp;</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">!</span><span style="color:#24292F;">isFlushPending) {</span></span>
<span class="line"><span style="color:#24292F;">    isFlushPending </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">true</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// å‘èµ·å¼‚æ­¥ä»»åŠ¡</span></span>
<span class="line"><span style="color:#24292F;">    currentFlushPromise </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> resolvedPromise.</span><span style="color:#8250DF;">then</span><span style="color:#24292F;">(flushJobs)</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">resolvedPromise</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">Promise</span><span style="color:#24292F;">&lt;</span><span style="color:#0550AE;">any</span><span style="color:#24292F;">&gt; </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">Promise</span><span style="color:#24292F;">.</span><span style="color:#8250DF;">resolve</span><span style="color:#24292F;">()</span></span>
<span class="line"></span></code></pre></div><p>è¿™é‡Œæœ‰ç‚¹ä¸€è·Ÿ vue2 ä¸åŒçš„æ˜¯ï¼švue3 ä¸­ç›´æ¥åªä½¿ç”¨ Promise å»åšå¼‚æ­¥ä»»åŠ¡ï¼Œå¹¶æ²¡æœ‰åƒ vue2 å»åšå…¼å®¹é™çº§æ–¹æ¡ˆã€‚èƒ½å¤Ÿæ”¯æŒ vue3 çš„ç¯å¢ƒï¼Œä¹Ÿå°±æ˜¯æ”¯æŒ proxy apiï¼Œå¤§ä½“åŸºæœ¬éƒ½æ”¯æŒ Promiseã€‚</p><h3 id="è°ƒåº¦ç»†èŠ‚" tabindex="-1"><a class="header-anchor" href="#è°ƒåº¦ç»†èŠ‚" aria-hidden="true">#</a> è°ƒåº¦ç»†èŠ‚</h3><p>æ¥ä¸‹æ¥çœ‹çœ‹ flushJobs æ˜¯å¦‚ä½•æ‰§è¡Œæ›´æ–°ä»»åŠ¡ä»¥åŠä¸€äº›ç»†èŠ‚é—®é¢˜ã€‚</p><div class="language-typescript ext-ts"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">flushJobs</span><span style="color:#24292F;">(</span><span style="color:#953800;">seen</span><span style="color:#CF222E;">?:</span><span style="color:#24292F;"> </span><span style="color:#953800;">CountMap</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">  isFlushPending </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">false</span></span>
<span class="line"><span style="color:#24292F;">  isFlushing </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">true</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (__DEV__) {</span></span>
<span class="line"><span style="color:#24292F;">    seen </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> seen </span><span style="color:#CF222E;">||</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">new</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">Map</span><span style="color:#24292F;">()</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// æ‰§è¡Œ pre queue</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#8250DF;">flushPreFlushCbs</span><span style="color:#24292F;">(seen)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// Sort queue before flush.</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// This ensures that:</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// 1. Components are updated from parent to child. (because parent is always</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">//    created before the child so its render effect will have smaller</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">//    priority number)</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// 2. If a component is unmounted during a parent component&#39;s update,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">//    its update can be skipped.</span></span>
<span class="line"><span style="color:#24292F;">  queue.</span><span style="color:#8250DF;">sort</span><span style="color:#24292F;">((</span><span style="color:#953800;">a</span><span style="color:#24292F;">, </span><span style="color:#953800;">b</span><span style="color:#24292F;">) </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">getId</span><span style="color:#24292F;">(a) </span><span style="color:#CF222E;">-</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">getId</span><span style="color:#24292F;">(b))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// æ‰§è¡Œ render queue</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">try</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">for</span><span style="color:#24292F;"> (flushIndex </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">0</span><span style="color:#24292F;">; flushIndex </span><span style="color:#CF222E;">&lt;</span><span style="color:#24292F;"> queue.</span><span style="color:#0550AE;">length</span><span style="color:#24292F;">; flushIndex</span><span style="color:#CF222E;">++</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">job</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> queue[flushIndex]</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (job </span><span style="color:#CF222E;">&amp;&amp;</span><span style="color:#24292F;"> job.active </span><span style="color:#CF222E;">!==</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">false</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (__DEV__ </span><span style="color:#CF222E;">&amp;&amp;</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">checkRecursiveUpdates</span><span style="color:#24292F;">(seen</span><span style="color:#CF222E;">!</span><span style="color:#24292F;">, job)) {</span></span>
<span class="line"><span style="color:#24292F;">          </span><span style="color:#CF222E;">continue</span></span>
<span class="line"><span style="color:#24292F;">        }</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#6E7781;">// console.log(`running:`, job.id)</span></span>
<span class="line"><span style="color:#24292F;">        </span><span style="color:#8250DF;">callWithErrorHandling</span><span style="color:#24292F;">(job, </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">, ErrorCodes.</span><span style="color:#0550AE;">SCHEDULER</span><span style="color:#24292F;">)</span></span>
<span class="line"><span style="color:#24292F;">      }</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">  } </span><span style="color:#CF222E;">finally</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">    flushIndex </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">0</span></span>
<span class="line"><span style="color:#24292F;">    queue.</span><span style="color:#0550AE;">length</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">0</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// æ‰§è¡Œ post queue</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#8250DF;">flushPostFlushCbs</span><span style="color:#24292F;">(seen)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">    isFlushing </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">false</span></span>
<span class="line"><span style="color:#24292F;">    currentFlushPromise </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// some postFlushCb queued jobs!</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// keep flushing until it drains.</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (</span></span>
<span class="line"><span style="color:#24292F;">      queue.</span><span style="color:#0550AE;">length</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">||</span></span>
<span class="line"><span style="color:#24292F;">      pendingPreFlushCbs.</span><span style="color:#0550AE;">length</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">||</span></span>
<span class="line"><span style="color:#24292F;">      pendingPostFlushCbs.</span><span style="color:#0550AE;">length</span></span>
<span class="line"><span style="color:#24292F;">    ) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#8250DF;">flushJobs</span><span style="color:#24292F;">(seen)</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span></code></pre></div><p>ä»ä¸Šçœ‹å‡º</p><ol><li>é˜Ÿåˆ—çš„æ‰§è¡Œé¡ºåºä¾æ¬¡ä¸º pre queueã€render queueã€post queue</li><li>render queue æ‰§è¡Œå‰éœ€è¦æ’åºï¼Œä¸ºä»€ä¹ˆï¼Ÿ</li></ol><p>è¿™ä¸»è¦è·Ÿ vue ç»„ä»¶çš„æ¸²æŸ“æœºåˆ¶æœ‰å…³ï¼Œä¸€ä¸ª vue ç»„ä»¶å‘ç”Ÿæ›´æ–°æœ‰ä¸¤ç§æƒ…å†µï¼š</p><ul><li>ä¾èµ–çš„å“åº”æ€§ state å‘ç”Ÿä¿®æ”¹</li><li>è‡ªèº« props å‘ç”Ÿä¿®æ”¹</li></ul><p>props æ˜¯ç”±çˆ¶ç»„ä»¶ä¼ å…¥ï¼Œæ˜¯åœ¨ render è¿‡ç¨‹ä¸­ã€‚å½“ props å‘ç”Ÿæ”¹ï¼Œå­ç»„ä»¶ä¹Ÿä¼šå‘ç”Ÿæ›´æ–°ï¼Œ<strong>æ•´ä¸ªç»„ä»¶æ ‘çš„åˆ›å»ºæ›´æ–°é¡ºåºéƒ½æ˜¯ä»çˆ¶åˆ°å­</strong>ã€‚</p><p>ä½†æœ‰ä¸€ç§æƒ…å†µï¼Œå°±æ˜¯çˆ¶å­ç»„ä»¶åˆšå¥½ä¾èµ–åˆ°åŒä¸€ä¸ª stateï¼Œè¿™ä¼šå¯¼è‡´ render queue é‡ŒåŒæ—¶å­˜åœ¨çˆ¶å­ç»„ä»¶çš„ render ä»»åŠ¡ï¼Œæ›´åçš„æƒ…å†µæ˜¯å­ render ä»»åŠ¡å¯èƒ½æ’åœ¨çˆ¶ render å‰ã€‚</p><p><img src="/assets/img/0f8bc010ae31abd663a9a31301c36e79ac2b0165e3f52274b53bae1dd0268173.fda3fe89.png" alt="å›¾ 12"></p><p>å­ render ä»»åŠ¡æœ¬æ¥å°±ä¼šæ›´æ–°å­ç»„ä»¶ï¼Œè€Œçˆ¶ render ä»»åŠ¡å¯èƒ½ä¿®æ”¹å­ç»„ä»¶çš„ props åŒæ ·ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´å­ç»„ä»¶æ›´æ–°ï¼Œä¹Ÿå°±æ˜¯è¯´ çˆ¶ rennder ä»»åŠ¡å…¶å®å¯èƒ½åŒ…å«å­ render ä»»åŠ¡ï¼Œé‚£è¿™æ ·å°±ä¼šå¯¼è‡´å­ç»„ä»¶åœ¨åŒä¸€ä¸ª tick ä¸­ render ä¸¤æ¬¡ã€‚</p><p>æºç ä¸­å…ˆè¿›è¡Œçˆ¶å­æ’åºï¼Œå…ˆæ‰§è¡Œçˆ¶ render ä»»åŠ¡ï¼Œå¹¶ä¸”åœ¨æ›´æ–°å­ç»„ä»¶ä¹‹å‰å…ˆèƒ½å¤Ÿ <code>invalidateJob(instance.update)</code> æŠŠé˜Ÿåˆ—ä¸­çš„å­ render ä»»åŠ¡åˆ é™¤ï¼Œè¿™æ ·åšå°±ä¸ä¼šé‡å¤æ›´æ–°å­ç»„ä»¶ã€‚</p><div class="language-typescript ext-ts"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">updateComponent</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (</span><span style="color:#953800;">n1</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;">, </span><span style="color:#953800;">n2</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;">, </span><span style="color:#953800;">optimized</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">boolean</span><span style="color:#24292F;">) </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">instance</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (n2.component </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> n1.component)</span><span style="color:#CF222E;">!</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (</span><span style="color:#8250DF;">shouldUpdateComponent</span><span style="color:#24292F;">(n1, n2, optimized)) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">//...</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// normal update</span></span>
<span class="line"><span style="color:#24292F;">      instance.next </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> n2</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// in case the child component is also queued, remove it to avoid</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// double updating the same child component in the same flush.</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#8250DF;">invalidateJob</span><span style="color:#24292F;">(instance.update)</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// instance.update is the reactive effect.</span></span>
<span class="line"><span style="color:#24292F;">      instance.</span><span style="color:#8250DF;">update</span><span style="color:#24292F;">()</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">//...</span></span>
<span class="line"><span style="color:#24292F;">    } </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">// no update needed. just copy over properties</span></span>
<span class="line"><span style="color:#24292F;">      n2.component </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> n1.component</span></span>
<span class="line"><span style="color:#24292F;">      n2.el </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> n1.el</span></span>
<span class="line"><span style="color:#24292F;">      instance.vnode </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> n2</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"></span></code></pre></div><p>æ¥ä¸‹æ¥çœ‹ï¼Œå½“ä¸€ä¸ªç»„ä»¶ä¾èµ–çš„å¤šä¸ªçŠ¶æ€åŒæ—¶å‘ç”Ÿå˜æ›´æ—¶ï¼š</p><p><img src="/assets/img/c6bc7c326a444056906400fd1f0b15c4b614d7e91f756d5c3f55191ec1f2e87e.0ede5959.png" alt="å›¾ 13"></p><div class="language-typescript ext-ts"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#CF222E;">export</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">queueJob</span><span style="color:#24292F;">(</span><span style="color:#953800;">job</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">SchedulerJob</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (</span></span>
<span class="line"><span style="color:#24292F;">    (</span><span style="color:#CF222E;">!</span><span style="color:#24292F;">queue.</span><span style="color:#0550AE;">length</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">||</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">!</span><span style="color:#24292F;">queue.</span><span style="color:#8250DF;">includes</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">        job,</span></span>
<span class="line"><span style="color:#24292F;">        isFlushing </span><span style="color:#CF222E;">&amp;&amp;</span><span style="color:#24292F;"> job.allowRecurse </span><span style="color:#CF222E;">?</span><span style="color:#24292F;"> flushIndex </span><span style="color:#CF222E;">+</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">1</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> flushIndex</span></span>
<span class="line"><span style="color:#24292F;">      )) </span><span style="color:#CF222E;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292F;">    job </span><span style="color:#CF222E;">!==</span><span style="color:#24292F;"> currentPreFlushParentJob</span></span>
<span class="line"><span style="color:#24292F;">  ) {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (job.id </span><span style="color:#CF222E;">==</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">      queue.</span><span style="color:#8250DF;">push</span><span style="color:#24292F;">(job)</span></span>
<span class="line"><span style="color:#24292F;">    } </span><span style="color:#CF222E;">else</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">      queue.</span><span style="color:#8250DF;">splice</span><span style="color:#24292F;">(</span><span style="color:#8250DF;">findInsertionIndex</span><span style="color:#24292F;">(job.id), </span><span style="color:#0550AE;">0</span><span style="color:#24292F;">, job)</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#8250DF;">queueFlush</span><span style="color:#24292F;">()</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span></code></pre></div><p>å…¶ä¸­</p><ol><li>åœ¨æ‰§è¡Œæ¸…ç©ºæ‰€æœ‰ä»»åŠ¡é˜Ÿåˆ—å‰å…ˆå»é‡ã€‚ï¼ˆè¿™æ—¶è¿˜æ²¡ flushingï¼Œ flushIndex ä¸º 0ï¼Œæ„å‘³ç€å³æ•´ä¸ªé˜Ÿåˆ—å»é‡ï¼‰</li><li>ä½†æ‰§è¡Œé˜Ÿåˆ—ä»»åŠ¡è¿‡ç¨‹åˆå¯ä»¥æ ¹æ® <code>job.allowRecurse</code> æ¡ä»¶æ’å…¥ä»»åŠ¡ã€æˆ–è€…é‡å¤ä»»åŠ¡ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ</li></ol><p><img src="/assets/img/0af1f873ecd39740f507a6003defe704cdd24ffbc201c2077d3c92af13b0d297.b05f4263.png" alt="å›¾ 14"></p><p>å›¾ä¸Šæœ‰ä¸¤å¤„å¾ªç¯ï¼š</p><p>åœ¨æ‰§è¡Œ pre queue ä¸­çš„ watcher æ—¶ï¼Œwatcher å¯èƒ½ä¼šä¿®æ”¹ stateï¼Œäº§ç”Ÿæ–°çš„ watcher æ’å…¥ pre queue ä¸­ï¼Œæ‰€ä»¥å¿…é¡»å¾ªç¯å¤„ç†å®Œ pre queue ä¸­ä»»åŠ¡ï¼Œä¿è¯åœ¨æ‰§è¡Œ render åè§†å›¾æ•°æ®ä¸€è‡´ã€‚</p><div class="language-typescript ext-ts"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#CF222E;">export</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">flushPreFlushCbs</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">seen</span><span style="color:#CF222E;">?:</span><span style="color:#24292F;"> </span><span style="color:#953800;">CountMap</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">parentJob</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">SchedulerJob</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span></span>
<span class="line"><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (pendingPreFlushCbs.</span><span style="color:#0550AE;">length</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">    currentPreFlushParentJob </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> parentJob </span><span style="color:#6E7781;">// å…ˆå¿½ç•¥</span></span>
<span class="line"><span style="color:#24292F;">    activePreFlushCbs </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> [</span><span style="color:#CF222E;">...new</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">Set</span><span style="color:#24292F;">(pendingPreFlushCbs)]</span></span>
<span class="line"><span style="color:#24292F;">    pendingPreFlushCbs.</span><span style="color:#0550AE;">length</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">0</span></span>
<span class="line"><span style="color:#24292F;">    </span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">for</span><span style="color:#24292F;"> (</span></span>
<span class="line"><span style="color:#24292F;">      preFlushIndex </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">0</span><span style="color:#24292F;">;</span></span>
<span class="line"><span style="color:#24292F;">      preFlushIndex </span><span style="color:#CF222E;">&lt;</span><span style="color:#24292F;"> activePreFlushCbs.</span><span style="color:#0550AE;">length</span><span style="color:#24292F;">;</span></span>
<span class="line"><span style="color:#24292F;">      preFlushIndex</span><span style="color:#CF222E;">++</span></span>
<span class="line"><span style="color:#24292F;">    ) {</span></span>
<span class="line"><span style="color:#24292F;">      </span></span>
<span class="line"><span style="color:#24292F;">      activePreFlushCbs[preFlushIndex]()</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">    activePreFlushCbs </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span></span>
<span class="line"><span style="color:#24292F;">    preFlushIndex </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">0</span></span>
<span class="line"><span style="color:#24292F;">    currentPreFlushParentJob </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// recursively flush until it drains</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// é€’å½’å¤„ç†</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#8250DF;">flushPreFlushCbs</span><span style="color:#24292F;">(seen, parentJob)</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span></code></pre></div><p>åœ¨æ‰§è¡Œ render ä»»åŠ¡æ—¶ï¼Œè¿™æ—¶ props çš„æ”¹å˜å¯èƒ½ä¼šè§¦å‘å­ç»„ä»¶çš„ watcherï¼Œåœ¨æ¸²æŸ“å­ç»„ä»¶å‰åŒæ ·å¿…é¡»å…ˆæ¸…ç©º pre queueã€‚åŒæ—¶è¦æ³¨æ„é˜²æ­¢å¾€ render queue ä¸­æ’å…¥å­ render ä»»åŠ¡ï¼Œå› ä¸ºå½“å‰çš„ render ä»»åŠ¡åŒ…å«äº†å­ render ä»»åŠ¡è¦æ‰§è¡Œã€‚</p><div class="language-typescript ext-ts"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#6E7781;">// packages/runtime-core/src/renderer.ts</span></span>
<span class="line"><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">updateComponentPreRender</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> (</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#953800;">instance</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">ComponentInternalInstance</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#953800;">nextVNode</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">VNode</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#953800;">optimized</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">boolean</span></span>
<span class="line"><span style="color:#24292F;">) </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#6E7781;">// çœç•¥ä»£ç ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#6E7781;">// props update may have triggered pre-flush watchers.</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#6E7781;">// flush them before the render update.</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#6E7781;">// æ¸²æŸ“å‰æ¸…ç©º pre queue</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#6E7781;">// ç¬¬äºŒå‚æ•°è®°å½•å½“å‰è°ƒç”¨æ ˆä¸­çš„çˆ¶ä»»åŠ¡ï¼Œæ­¤æ—¶å³ä¸ºå­ render</span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#8250DF;">flushPreFlushCbs</span><span style="color:#24292F;">(</span><span style="color:#0550AE;">undefined</span><span style="color:#24292F;">, instance.update)</span></span>
<span class="line"><span style="color:#24292F;"> </span></span>
<span class="line"><span style="color:#24292F;"> </span><span style="color:#6E7781;">// ...</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CF222E;">export</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">flushPreFlushCbs</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">seen</span><span style="color:#CF222E;">?:</span><span style="color:#24292F;"> </span><span style="color:#953800;">CountMap</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">parentJob</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">SchedulerJob</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">null</span></span>
<span class="line"><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (pendingPreFlushCbs.</span><span style="color:#0550AE;">length</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// å…¨å±€å˜é‡æ ‡è®°</span></span>
<span class="line"><span style="color:#24292F;">    currentPreFlushParentJob </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> parentJob</span></span>
<span class="line"><span style="color:#24292F;">    </span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// ... ä»»åŠ¡æ‰§è¡Œ</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// recursively flush until it drains</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#8250DF;">flushPreFlushCbs</span><span style="color:#24292F;">(seen, parentJob)</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CF222E;">export</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">queueJob</span><span style="color:#24292F;">(</span><span style="color:#953800;">job</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">SchedulerJob</span><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (</span></span>
<span class="line"><span style="color:#24292F;">    (</span><span style="color:#CF222E;">!</span><span style="color:#24292F;">queue.</span><span style="color:#0550AE;">length</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">||</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#CF222E;">!</span><span style="color:#24292F;">queue.</span><span style="color:#8250DF;">includes</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">        job,</span></span>
<span class="line"><span style="color:#24292F;">        isFlushing </span><span style="color:#CF222E;">&amp;&amp;</span><span style="color:#24292F;"> job.allowRecurse </span><span style="color:#CF222E;">?</span><span style="color:#24292F;"> flushIndex </span><span style="color:#CF222E;">+</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">1</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> flushIndex</span></span>
<span class="line"><span style="color:#24292F;">      )) </span><span style="color:#CF222E;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// ä»»åŠ¡å¯¹æ¯”ï¼Œé˜²æ­¢é‡å¤æ’å…¥</span></span>
<span class="line"><span style="color:#24292F;">    job </span><span style="color:#CF222E;">!==</span><span style="color:#24292F;"> currentPreFlushParentJob</span></span>
<span class="line"><span style="color:#24292F;">  ) {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">//...</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span></code></pre></div><p>ä½†æ˜¯æˆ‘ä»¬åŒæ ·ä¹Ÿéœ€è¦æ³¨æ„ä¸ªé—®é¢˜ï¼šä¸Šé¢è™½ç„¶è§£å†³äº†å­ render é‡å¤çš„é—®é¢˜ï¼Œä½† watcher ä¸­å¯èƒ½ä¼š<strong>ä¿®æ”¹åˆ°äº†çˆ¶ç»„ä»¶çš„ä¾èµ–</strong>ï¼</p><p>ä¸€ä¸ª render ä»»åŠ¡æ‰§è¡Œçš„æ—¶å€™æœ‰ä¸¤ä¸ªé‡è¦è¿‡ç¨‹ï¼š</p><ol><li>åˆ›å»ºæ–°çš„ subTree</li><li>diff æ–°æ—§ subTree</li></ol><p>åœ¨ patch è¿‡ç¨‹ï¼Œå­ç»„ä»¶ props å‘ç”Ÿäº†ä¿®æ”¹è€Œè§¦å‘çš„ watcher ä¿®æ”¹åˆ°çˆ¶ç»„ä»¶ä¾èµ–çŠ¶æ€ã€‚é‚£ä¹ˆè¿™æ—¶çˆ¶ render è¿‡ç¨‹ç”Ÿæˆçš„æ–°çš„ subTree å…¶å®å·²ç»ä¸æ˜¯æœ€æ–°çŠ¶æ€çš„æ˜ å°„äº†ï¼Œå¯¼è‡´æœ€åè§†å›¾ä¸ä¸€è‡´ï¼Œæ‰€ä»¥éœ€è¦ä¸ª<strong>å¼¥è¡¥æœºåˆ¶</strong>ï¼Œçˆ¶ç»„ä»¶å† render ä¸€æ¬¡ã€‚</p><p><img src="/assets/img/90c2621f65c020b6b2695cec35bdb6bf2fe9a74acd9a81bc4d5ae44e2b975f9a.3138786f.png" alt="å›¾ 15"></p><p>queueJob ä¸­ <code>isFlushing &amp;&amp; job.allowRecurse ? flushIndex + 1 : flushIndex</code> é‡Œ <code>flushIndex + 1</code> ä½¿å¾—èƒ½å¤Ÿæ’å…¥é‡å¤ render ä»»åŠ¡ã€‚</p><blockquote><p>è¿™é‡Œæœ‰ä¸ª <a href="https://github.com/vuejs/vue-next/issues/1801" target="_blank" rel="noopener noreferrer">issue<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ä¸Šé¢çš„ç¤ºä¾‹å¯ä»¥å»è°ƒè¯•çœ‹çœ‹ã€‚</p></blockquote><h2 id="reactiveeffect-allowrecurse" tabindex="-1"><a class="header-anchor" href="#reactiveeffect-allowrecurse" aria-hidden="true">#</a> <a href="#Effect.allowRecurse">ReactiveEffect.allowRecurse</a></h2><p>ReactiveEffect.allowRecurse å¹¶æ²¡æœ‰è¿‡å¤šçš„æ³¨é‡Šï¼Œä½†æˆ‘ä»¬å¯ä»¥ä» <code>packages/runtime-core/src/scheduler.ts</code> ä¸­å‘ç°ç›¸å…³æ³¨é‡Šï¼Œå…¶å® Render ReactiveEffect å°±æ˜¯ SchedulerJobã€‚</p><div class="language-typescript ext-ts"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#CF222E;">export</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">interface</span><span style="color:#24292F;"> </span><span style="color:#953800;">SchedulerJob</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">extends</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">Function</span><span style="color:#24292F;"> {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">id</span><span style="color:#CF222E;">?:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">number</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">active</span><span style="color:#CF222E;">?:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">boolean</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">computed</span><span style="color:#CF222E;">?:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">boolean</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">/**</span></span>
<span class="line"><span style="color:#6E7781;">   * Indicates whether the effect is allowed to recursively trigger itself</span></span>
<span class="line"><span style="color:#6E7781;">   * when managed by the scheduler.</span></span>
<span class="line"><span style="color:#6E7781;">   *</span></span>
<span class="line"><span style="color:#6E7781;">   * By default, a job cannot trigger itself because some built-in method calls,</span></span>
<span class="line"><span style="color:#6E7781;">   * e.g. Array.prototype.push actually performs reads as well (#1740) which</span></span>
<span class="line"><span style="color:#6E7781;">   * can lead to confusing infinite loops.</span></span>
<span class="line"><span style="color:#6E7781;">   * The allowed cases are component update functions and watch callbacks.</span></span>
<span class="line"><span style="color:#6E7781;">   * Component update functions may update child component props, which in turn</span></span>
<span class="line"><span style="color:#6E7781;">   * trigger flush: &quot;pre&quot; watch callbacks that mutates state that the parent</span></span>
<span class="line"><span style="color:#6E7781;">   * relies on (#1801). Watch callbacks doesn&#39;t track its dependencies so if it</span></span>
<span class="line"><span style="color:#6E7781;">   * triggers itself again, it&#39;s likely intentional and it is the user&#39;s</span></span>
<span class="line"><span style="color:#6E7781;">   * responsibility to perform recursive state mutation that eventually</span></span>
<span class="line"><span style="color:#6E7781;">   * stabilizes (#1727).</span></span>
<span class="line"><span style="color:#6E7781;">   */</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">allowRecurse</span><span style="color:#CF222E;">?:</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">boolean</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">/**</span></span>
<span class="line"><span style="color:#6E7781;">   * Attached by renderer.ts when setting up a component&#39;s render effect</span></span>
<span class="line"><span style="color:#6E7781;">   * Used to obtain component information when reporting max recursive updates.</span></span>
<span class="line"><span style="color:#6E7781;">   * dev only.</span></span>
<span class="line"><span style="color:#6E7781;">   */</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">ownerInstance</span><span style="color:#CF222E;">?:</span><span style="color:#24292F;"> </span><span style="color:#953800;">ComponentInternalInstance</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span></code></pre></div><p>ReactiveEffect åˆ›å»ºå®ä¾‹æ—¶å…¶ allowRecurse æ˜¯ä¸º undefinedï¼Œå¯ä»¥è¯´æ˜¯ falseï¼Œåœ¨åŒä¸€ effect ä¸‹æ˜¯ä¸ä¼šè§¦å‘é‡å¤é€’å½’çš„ã€‚</p><div class="language-typescript ext-ts"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#CF222E;">export</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">triggerEffects</span><span style="color:#24292F;">(</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">dep</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">Dep</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">|</span><span style="color:#24292F;"> </span><span style="color:#953800;">ReactiveEffect</span><span style="color:#24292F;">[],</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#953800;">debuggerEventExtraInfo</span><span style="color:#CF222E;">?:</span><span style="color:#24292F;"> </span><span style="color:#953800;">DebuggerEventExtraInfo</span></span>
<span class="line"><span style="color:#24292F;">) {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#6E7781;">// spread into array for stabilization</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">for</span><span style="color:#24292F;"> (</span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">effect</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">of</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">isArray</span><span style="color:#24292F;">(dep) </span><span style="color:#CF222E;">?</span><span style="color:#24292F;"> dep </span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> [</span><span style="color:#CF222E;">...</span><span style="color:#24292F;">dep]) {</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#6E7781;">// é˜²æ­¢ effect é‡å¤è°ƒç”¨</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">if</span><span style="color:#24292F;"> (effect </span><span style="color:#CF222E;">!==</span><span style="color:#24292F;"> activeEffect </span><span style="color:#CF222E;">||</span><span style="color:#24292F;"> effect.allowRecurse) {</span></span>
<span class="line"><span style="color:#24292F;">      </span><span style="color:#6E7781;">//...</span></span>
<span class="line"><span style="color:#24292F;">    }</span></span>
<span class="line"><span style="color:#24292F;">  }</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span></code></pre></div><p>ä¸‹é¢ä¾‹å­ä¸­ï¼Œeffect ä¸­ä¿®æ”¹ test å€¼ï¼Œä½†å‰¯ä½œç”¨åªæ‰§è¡Œäº†ä¸€æ¬¡ã€‚</p><p><img src="/assets/img/a631cc0e1963f36f38f2426fc6dae0f9a7e799bf70325b35062b05462f495af8.58542777.png" alt="å›¾ 11"></p><p>è€Œ <strong>renderã€watcher æ˜¯å¯ä»¥é‡å¤é€’å½’</strong>ï¼Œå…¶ä¸­å¯é‡å¤ render æ˜¯æœ‰åœºæ™¯éœ€æ±‚ï¼Œè€Œwatcher åˆ™æ˜¯ä¸æƒ³è¿èƒŒæ¨¡å¼ï¼Œå¦‚æœ watcher é‡Œä¿®æ”¹æ•°æ®é‡æ–°è§¦å‘äº† watcherï¼Œé‚£æ›´å¤šæ˜¯ç”¨æˆ·çš„ä¸€ç§è´£ä»»è¡Œä¸ºã€‚</p><h2 id="nexttick" tabindex="-1"><a class="header-anchor" href="#nexttick" aria-hidden="true">#</a> nextTick</h2><div class="language-typescript ext-ts"><pre class="shiki" style="background-color:#ffffff;"><code><span class="line"><span style="color:#CF222E;">export</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">function</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">nextTick</span><span style="color:#24292F;">&lt;</span><span style="color:#953800;">T</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">void</span><span style="color:#24292F;">&gt;(</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#0550AE;">this</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">T</span><span style="color:#24292F;">,</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#8250DF;">fn</span><span style="color:#CF222E;">?:</span><span style="color:#24292F;"> (</span><span style="color:#0550AE;">this</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">T</span><span style="color:#24292F;">) </span><span style="color:#CF222E;">=&gt;</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">void</span></span>
<span class="line"><span style="color:#24292F;">)</span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> </span><span style="color:#953800;">Promise</span><span style="color:#24292F;">&lt;</span><span style="color:#0550AE;">void</span><span style="color:#24292F;">&gt; {</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">p</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">=</span><span style="color:#24292F;"> currentFlushPromise </span><span style="color:#CF222E;">||</span><span style="color:#24292F;"> resolvedPromise</span></span>
<span class="line"><span style="color:#24292F;">  </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> fn </span><span style="color:#CF222E;">?</span><span style="color:#24292F;"> p.</span><span style="color:#8250DF;">then</span><span style="color:#24292F;">(</span><span style="color:#0550AE;">this</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">?</span><span style="color:#24292F;"> fn.</span><span style="color:#8250DF;">bind</span><span style="color:#24292F;">(</span><span style="color:#0550AE;">this</span><span style="color:#24292F;">) </span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> fn) </span><span style="color:#CF222E;">:</span><span style="color:#24292F;"> p</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span></code></pre></div><p>ä½¿ç”¨ promise é“¾å¼è°ƒç”¨ï¼Œä¿è¯ nextTick çš„ä»»åŠ¡åœ¨å¼‚æ­¥æ›´æ–°ä»»åŠ¡åæ‰§è¡Œï¼Œè¿™æ ·æŸäº›æ’ä»¶å°±å¯ä»¥è·å¾—æ›´æ–°åçš„ DOMã€‚</p><h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h2><ol><li>å“åº”å¼æ¸²æŸ“æœºåˆ¶ï¼šå°†ç»„ä»¶æ¸²æŸ“å°è£…æˆæ¸²æŸ“å‰¯ä½œç”¨ï¼Œæ”¶é›†å“åº”å¼ä¾èµ–ï¼Œå¼‚æ­¥è°ƒåº¦æ›´æ–°ã€‚</li><li>vue çš„å¼‚æ­¥æ›´æ–°æœºåˆ¶ï¼šä½¿ç”¨é˜Ÿåˆ—ç¼“å­˜æ›´æ–°ä»»åŠ¡ï¼Œåœ¨äº‹ä»¶å¾ªç¯ä¸­å®‰æ’ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡æ‰§è¡Œé˜Ÿåˆ—ä¸­æ‰€æœ‰ä»»åŠ¡ã€‚</li><li>å¼‚æ­¥æ›´æ–°é˜²æ­¢é‡å¤æ¸²æŸ“ã€ä¿è¯å•å‘æ›´æ–°ã€‚</li><li>å•å‘æ•°æ®æµåŸåˆ™ï¼šç»„ä»¶æ ‘çš„æ›´æ–°è¿‡ç¨‹æ˜¯è‡ªé¡¶å‘ä¸‹ï¼Œå¦‚æœå‘ç”Ÿé€†å‘æ•°æ®æµä¿®æ”¹ï¼Œä¼šå¯¼è‡´å½“å‰æ¸²æŸ“çš„æ•°æ®å’Œè§†å›¾æ˜ å°„ä¸ä¸€è‡´ï¼Œéœ€è¦é‡å¤å¤šä¸€æ¬¡æ¸²æŸ“ã€‚</li></ol></div><!----></article></div><footer class="footer footer-center p-4 bg-base-300 text-base-content opacity-60"><div><p>Â©2017-2021 laoergege.cn. All right reserved. </p><p><a href="https://beian.miit.gov.cn" target="_blank" class="link link-hover">ç²¤ICPå¤‡2022020679å·</a></p></div></footer><!--]--><!----><!--]--></div>
    <script src="/assets/js/runtime~app.7d4bd660.js" defer></script><script src="/assets/js/5838.13a569e5.js" defer></script><script src="/assets/js/app.7e792774.js" defer></script>
</body>

</html>